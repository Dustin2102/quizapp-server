<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8" />
  <title>Leaderboard – Punkte nach Runden</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="stylesheet" href="style.css" />
  <style>
    :root{
      --fg:#0f172a; --muted:#64748b; --accent:#3b82f6;
      --bg-from:#ffffff; --bg-to:#f6f8fb; --card:#ffffff;
      --ring: rgba(59,130,246,.18); --border:#e5e7eb; --shadow:0 6px 20px rgba(2,6,23,.08);
    }
    html,body{height:100%}
    body{
      margin:0; padding:0; font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
      color:var(--fg); background:linear-gradient(180deg,var(--bg-from),var(--bg-to));
      min-height:100dvh;
    }
    .wrap{ width:min(1100px,96vw); margin:28px auto 40px; }
    h1{ margin:0 0 6px; }
    .sub{ color:var(--muted); margin:0 0 16px; }
    .toolbar{
      display:flex; flex-wrap:wrap; gap:10px; align-items:center;
      background:var(--card); border:1px solid var(--border); border-radius:14px; padding:12px; box-shadow:var(--shadow);
    }
    .toolbar > *{ margin-right:8px; }
    .btn{ padding:10px 14px; border:1px solid var(--border); border-radius:10px; background:#fff; cursor:pointer; }
    .btn:hover{ filter:saturate(1.05); }
    .switch{ display:inline-flex; align-items:center; gap:6px; }
    select, input{
      padding:10px 12px; border:1px solid var(--border); border-radius:10px; outline:none;
    }
    select:focus, input:focus{ box-shadow:0 0 0 4px var(--ring); }
    .card{
      background:var(--card); border:1px solid var(--border); border-radius:16px; padding:16px; box-shadow:var(--shadow);
      margin-top:14px; overflow:auto;
    }
    table{ width:100%; border-collapse:collapse; font-size:14px; }
    thead th{
      position:sticky; top:0; background:#f8fafc; border-bottom:1px solid var(--border);
      text-align:left; padding:10px; font-weight:700;
    }
    tbody td{ border-bottom:1px solid #eef2f7; padding:8px 10px; }
    .pos{ width:48px; text-align:right; }
    .team{ min-width:180px; }
    .total{ font-weight:800; }
    .muted{ color:var(--muted); }
    .right{ text-align:right; }
  </style>
</head>
<body>
  <div class="wrap">
    <h1>Leaderboard</h1>
    <p class="sub">Gesamtpunkte und Aufschlüsselung pro Runde. Dynamisch bis zu 10 Runden.</p>

    <div class="toolbar">
      <label>Max. Runden:
        <select id="maxRounds">
          <option value="6">6</option>
          <option value="7">7</option>
          <option value="8">8</option>
          <option value="9">9</option>
          <option value="10" selected>10</option>
        </select>
      </label>

      <label>Team filtern:
        <input type="text" id="teamFilter" placeholder="Teamname…">
      </label>

      <button class="btn" id="reloadBtn">Neu laden</button>

      <span class="switch">
        <input type="checkbox" id="autoRefresh" />
        <label for="autoRefresh">Auto-Refresh (alle 5 s)</label>
      </span>

      <span id="status" class="muted"></span>
    </div>

    <div class="card">
      <table id="board">
        <thead id="thead"></thead>
        <tbody id="tbody"></tbody>
      </table>
    </div>
  </div>

  <script>
    // ===== Einstellungen =====
    const thead = document.getElementById('thead');
    const tbody = document.getElementById('tbody');
    const statusEl = document.getElementById('status');
    const reloadBtn = document.getElementById('reloadBtn');
    const teamFilter = document.getElementById('teamFilter');
    const autoRefresh = document.getElementById('autoRefresh');
    const maxRoundsSel = document.getElementById('maxRounds');

    let timer = null;

    function status(txt){ statusEl.textContent = txt; }
    function esc(s){ return s.replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m])); }

    function buildHead(maxRounds){
      thead.innerHTML = '';
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <th class="pos">#</th>
        <th class="team">Team</th>
        <th class="right total">Gesamt</th>
      `;
      for(let r=1;r<=maxRounds;r++){
        const th = document.createElement('th');
        th.className = 'right';
        th.textContent = `R${r}`;
        tr.appendChild(th);
      }
      thead.appendChild(tr);
    }

    async function loadData(){
      // Scores laden
      const scores = await fetch('/scores').then(r=>r.json()).catch(()=> ({}));
      // Teams-Liste, damit auch Teams ohne Punkte angezeigt werden
      const teams = await fetch('/teams').then(r=>r.json()).catch(()=> []);

      return { scores, teams };
    }

    function normalize(scores, teams, maxRounds, filterText){
      const list = [];
      const set = new Set(teams);
      // alle Teams aus Scores auch aufnehmen
      Object.keys(scores||{}).forEach(t=>set.add(t));

      for(const team of Array.from(set)){
        if (filterText && !team.toLowerCase().includes(filterText)) continue;

        const byRound = [];
        let sum = 0;

        for(let r=1;r<=maxRounds;r++){
          // Wir erwarten Keys "Runde 1", "Runde 2", ...
          const val = Number((scores[team]||{})[`Runde ${r}`] ?? 0);
          byRound.push(val);
          sum += val;
        }
        list.push({ team, byRound, sum });
      }

      // Sortierung: Gesamt desc, dann Teamname asc
      list.sort((a,b)=> (b.sum - a.sum) || a.team.localeCompare(b.team,'de'));
      return list;
    }

    function render(list, maxRounds){
      tbody.innerHTML = '';
      if(list.length===0){
        const tr = document.createElement('tr');
        const td = document.createElement('td');
        td.colSpan = 3 + maxRounds;
        td.className = 'muted';
        td.textContent = 'Keine Teams gefunden.';
        tr.appendChild(td);
        tbody.appendChild(tr);
        return;
      }

      let pos = 1;
      for(const row of list){
        const tr = document.createElement('tr');

        const tdPos = document.createElement('td');
        tdPos.className = 'pos';
        tdPos.textContent = pos++;
        tr.appendChild(tdPos);

        const tdTeam = document.createElement('td');
        tdTeam.className = 'team';
        tdTeam.textContent = row.team;
        tr.appendChild(tdTeam);

        const tdTotal = document.createElement('td');
        tdTotal.className = 'right total';
        tdTotal.textContent = row.sum;
        tr.appendChild(tdTotal);

        for(const v of row.byRound){
          const td = document.createElement('td');
          td.className = 'right';
          td.textContent = v;
          tr.appendChild(td);
        }
        tbody.appendChild(tr);
      }
    }

    async function loadAndRender(){
      clearTimeout(timer);
      const maxRounds = parseInt(maxRoundsSel.value,10);
      buildHead(maxRounds);
      status('Lade …');
      try{
        const {scores, teams} = await loadData();
        const filterTxt = (teamFilter.value||'').toLowerCase().trim();
        const data = normalize(scores, teams, maxRounds, filterTxt);
        render(data, maxRounds);
        status(`${data.length} Teams • bis Runde ${maxRounds}`);
      }catch(e){
        console.error(e);
        status('Fehler beim Laden');
      }finally{
        if (autoRefresh.checked){
          timer = setTimeout(loadAndRender, 5000);
        }
      }
    }

    // Events
    reloadBtn.addEventListener('click', loadAndRender);
    teamFilter.addEventListener('input', () => { if(!autoRefresh.checked) loadAndRender(); });
    autoRefresh.addEventListener('change', loadAndRender);
    maxRoundsSel.addEventListener('change', loadAndRender);

    // Init
    (async function init(){
      // versuche, aktuelle Runde zu lesen und geeignetes "Max. Runden" zu setzen
      try{
        const cr = await fetch('/current-round').then(r=>r.json());
        const r = parseInt(cr.round||6,10);
        // Wenn z.B. schon Runde 8 läuft, automatisch 10 anzeigen
        if (r>6) maxRoundsSel.value = String(Math.min(10, Math.max(6, r)));
      }catch{}
      loadAndRender();
    })();
  </script>
</body>
</html>