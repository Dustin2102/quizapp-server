<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8" />
  <title>Live-Auswertung</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <meta http-equiv="Cache-Control" content="no-store" />
  <style>
    :root{
      --bg:#0b1020; --card:#0f1530; --muted:#9fb0d0; --fg:#e8eeff;
      --accent:#7cc4ff; --line:#2a355b; --ok:#29d398;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0; background:radial-gradient(1200px 800px at 20% -10%, #182041 0, #0b1020 60%);
      color:var(--fg); font-family:system-ui,Segoe UI,Roboto,Arial,sans-serif;
      display:flex; align-items:center; justify-content:center; padding:24px;
    }
    .wrap{ width:min(1100px, 96vw); }
    header{
      display:flex; align-items:center; gap:16px; justify-content:space-between; margin-bottom:14px;
    }
    h1{ margin:0; font-size:clamp(1.6rem,1.1rem + 2.2vw,2.6rem); letter-spacing:.4px }
    .meta{ color:var(--muted); font-size:.95rem }
    .badge{
      border:1px solid var(--line); background:#0d1430; border-radius:999px; padding:.35rem .7rem; font-weight:700;
    }
    table{
      width:100%; border-collapse:separate; border-spacing:0 10px; font-size:clamp(1rem, .9rem + .7vw, 1.35rem);
    }
    thead th{
      color:var(--muted); text-align:left; padding:8px 14px; font-weight:700;
      border-bottom:1px solid var(--line);
    }
    tbody tr{
      background:linear-gradient(180deg, #12193b, #0d1430);
      border:1px solid var(--line); border-radius:12px;
      box-shadow:0 6px 16px rgba(0,0,0,.25);
    }
    tbody td{ padding:12px 14px; }
    tbody tr td:first-child{ border-top-left-radius:12px; border-bottom-left-radius:12px; width:110px; }
    tbody tr td:last-child{ border-top-right-radius:12px; border-bottom-right-radius:12px; text-align:right; font-weight:800; color:var(--ok) }
    .rank{ font-weight:900; color:var(--accent) }
    .small{ font-size:.92rem; color:var(--muted); margin-top:6px }
    footer{ margin-top:12px; color:var(--muted); font-size:.92rem; display:flex; justify-content:space-between }
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <h1>ðŸ“Š Live-Auswertung</h1>
      <div class="meta">
        <span id="roundBadge" class="badge">â€“</span>
      </div>
    </header>

    <table>
      <thead>
        <tr><th>Platz</th><th>Team</th><th>Punkte</th></tr>
      </thead>
      <tbody id="rows"></tbody>
    </table>

    <footer>
      <div class="small">Aktualisiert: <span id="ts">â€“</span></div>
      <div class="small">Quelle: Antworten &amp; richtige LÃ¶sungen (live berechnet)</div>
    </footer>
  </div>

  <script>
    const $ = (s)=>document.querySelector(s);
    const now = ()=> new Date().toLocaleTimeString("de-DE",{hour12:false});
    async function getJSON(url){
      const r = await fetch(url+(url.includes('?')?'&':'?')+'_='+Date.now());
      if(!r.ok) throw new Error(url+' -> '+r.status);
      return r.json();
    }

    const normList = v => {
      if (Array.isArray(v)) return v.map(x=>String(x).trim()).filter(Boolean);
      if (typeof v === "string") return v.split(/[;,|]/g).map(s=>s.trim()).filter(Boolean);
      return [];
    };
    function correctList(roundObj, qIdx){
      if(!roundObj) return [];
      const objVal = roundObj[`question_${qIdx}`];
      if (typeof objVal !== "undefined") return normList(objVal);
      const arrVal = roundObj[qIdx-1];
      return normList(arrVal);
    }

    async function computeScores(){
      const [status, answersAll, correctAll] = await Promise.all([
        getJSON("/current-round"),
        getJSON("/data/teamAnswers.json"),
        getJSON("/correct-answers"),
      ]);

      $("#roundBadge").textContent = `Runde ${status.round} â€“ ${status.closed ? "geschlossen" : "offen"}`;

      const teams = new Set();
      Object.values(answersAll).forEach(r => { if(r) Object.keys(r).forEach(t => teams.add(t)); });

      const totals = {};
      for (const team of teams) {
        let sum = 0;
        for (let r = 1; r <= 6; r++) {
          const roundAnswers = (answersAll[`round_${r}`] || {})[team];
          if (!roundAnswers) continue;
          const a = roundAnswers.answers || [];
          const corrRound = correctAll[`round_${r}`] || {};
          let pts = 0;
          for (let i = 0; i < 12; i++) {
            const ua = (a[i] || "").toString().trim().toLowerCase();
            const list = correctList(corrRound, i+1).map(s => s.toLowerCase().trim());
            if (ua && list.includes(ua)) pts++;
          }
          sum += pts;
        }
        totals[team] = sum;
      }

      const rows = Object.entries(totals).sort((a,b)=> b[1]-a[1]);
      const tbody = $("#rows");
      tbody.innerHTML = rows.map(([team, pts], i) =>
        `<tr>
           <td class="rank">#${i+1}</td>
           <td>${team}</td>
           <td>${pts}</td>
         </tr>`
      ).join("");

      $("#ts").textContent = now();
    }

    computeScores();
    setInterval(computeScores, 5000);
  </script>
</body>
</html>