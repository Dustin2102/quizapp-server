<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8" />
  <title>Admin-Panel – Steuerung & Auswertung</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="stylesheet" href="style.css" />
  <style>
    :root{
      --fg:#0f172a; --muted:#64748b; --accent:#2563eb;
      --ok:#16a34a; --warn:#f59e0b; --danger:#dc2626; --border:#e5e7eb;
      --card:#ffffff; --bg:#f6f8fb; --ring: rgba(37,99,235,.18);
      --shadow: 0 8px 28px rgba(2,6,23,.08);
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0; font-family:system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; color:var(--fg);
      background:linear-gradient(180deg,#fff,var(--bg));
      min-height:100dvh; padding-bottom:84px; /* Platz für Bottom-Bar */
    }
    .wrap{ width:min(1300px,96vw); margin:24px auto 40px; }

    h1{ margin:0 0 6px; }
    .sub{ color:var(--muted); margin:0 0 16px; }

    /* Toolbar */
    .toolbar{
      position:sticky; top:0; z-index:8;
      display:flex; flex-wrap:wrap; gap:10px; align-items:center;
      background:var(--card); border:1px solid var(--border); border-radius:14px; padding:12px; box-shadow:var(--shadow);
    }
    .toolbar .sp{ flex:1 1 auto }
    label{ font-weight:600; }
    select,input,button{
      padding:10px 12px; border:1px solid var(--border); border-radius:10px; outline:none; background:#fff;
      font-size:14px;
    }
    select:focus,input:focus{ box-shadow:0 0 0 4px var(--ring); }
    .btn{ cursor:pointer }
    .btn.primary{ background:linear-gradient(135deg,#22c55e,#16a34a); color:#fff; border:none; font-weight:800; }
    .btn.warn{ background:linear-gradient(135deg,#f59e0b,#d97706); color:#fff; border:none; font-weight:800; }
    .btn.ghost{ background:#fff }
    .link{ text-decoration:none; color:#0f172a; padding:10px 12px; border:1px solid var(--border); border-radius:10px; }
    .badge{
      display:inline-flex; align-items:center; gap:.4rem; padding:.35rem .6rem; border:1px solid var(--border);
      border-radius:999px; background:#fff;
    }
    .open{ background:#f0fdf4; border-color:#bbf7d0; color:#14532d; }
    .closed{ background:#fef2f2; border-color:#fecaca; color:#7f1d1d; }
    .status{ color:var(--muted); font-weight:700; }

    /* Tabs */
    .tabs{ display:flex; gap:8px; margin:14px 0 0; }
    .tab-btn{
      padding:10px 12px; border:1px solid var(--border); border-radius:10px; background:#fff; cursor:pointer; font-weight:700;
    }
    .tab-btn.active{ background:#eef2ff; border-color:#c7d2fe; color:#111827; }
    .view{ display:none; margin-top:12px; }
    .view.active{ display:block; }

    /* Cards + Tables */
    .card{ background:var(--card); border:1px solid var(--border); border-radius:16px; padding:16px; box-shadow:var(--shadow); }
    .grid{ display:grid; gap:14px; }
    @media(min-width:1000px){ .grid.cols-2{ grid-template-columns:1.1fr .9fr; } }

    table{ width:100%; border-collapse:collapse; font-size:14px; }
    thead th{ position:sticky; top:0; background:#f8fafc; border-bottom:1px solid var(--border); padding:8px; text-align:left; }
    tbody td{ border-bottom:1px solid #eef2f7; padding:8px; vertical-align:top; }

    .chip{ display:inline-block; padding:.2rem .5rem; border:1px solid var(--border); border-radius:999px; background:#fff; }
    .chip.ok{ background:#ecfdf5; border-color:#bbf7d0; color:#14532d; }
    .chip.no{ background:#fef2f2; border-color:#fecaca; color:#7f1d1d; }
    .right{text-align:right}
    .center{text-align:center}
    .mono{ font-family:ui-monospace,SFMono-Regular,Menlo,Consolas,"Liberation Mono",monospace; }

    /* Correct matrix */
    .matrix{ overflow:auto; }
    .matrix table th.sticky-left, .matrix table td.sticky-left{
      position:sticky; left:0; background:#fff; border-right:1px solid var(--border); z-index:1;
    }
    .matrix input{
      width:140px; max-width:140px; padding:8px; border:1px solid var(--border); border-radius:8px;
    }

    /* Bottom Active Bar */
    .activebar{
      position:fixed; left:0; right:0; bottom:0; z-index:10;
      background:#ffffffcc; backdrop-filter: blur(4px);
      border-top:1px solid var(--border); padding:10px 12px;
    }
    .activebar .row{ display:flex; gap:10px; align-items:center; flex-wrap:wrap; width:min(1300px,96vw); margin:0 auto; }
    .dot{ width:10px; height:10px; border-radius:50%; display:inline-block; }
    .dot.green{ background:var(--ok); }
    .dot.red{ background:var(--danger); }
    .dot.gray{ background:#cbd5e1; }
    .team-pill{
      display:inline-flex; align-items:center; gap:6px; border:1px solid var(--border); border-radius:999px; padding:.25rem .6rem; background:#fff;
    }
    .legend{ color:var(--muted); font-size:12px; }
  </style>
</head>
<body>
  <div class="wrap">
    <h1>Admin-Panel</h1>
    <p class="sub">Runden steuern, auswerten & alles im Blick. „Start“ = Runde 0, „Ende“ = Runde X.</p>

    <!-- Toolbar -->
    <div class="toolbar">
      <label>Runde:
        <select id="roundSel"></select>
      </label>

      <label>Status:
        <select id="statusSel">
          <option value="open">offen</option>
          <option value="closed">geschlossen</option>
        </select>
      </label>

      <button class="btn primary" id="applyBtn">Übernehmen</button>
      <button class="btn ghost" id="openBtn">Öffnen</button>
      <button class="btn warn" id="closeBtn">Schließen</button>

      <span class="badge" id="liveBadge">—</span>

      <span class="sp"></span>

      <!-- NEU: QR-Code -->
      <a class="link" href="qr.html" target="_blank">QR-Code</a>

      <a class="link" href="results.html" target="_blank">Antworten</a>
      <a class="link" href="reveal.html" target="_blank">Reveal</a>
      <a class="link" href="leaderboard.html" target="_blank">Leaderboard</a>
      <a class="link" href="active.html" target="_blank">Aktive Teams (Vollbild)</a>
      <a class="link" href="teams.html" target="_blank">Teams verwalten</a>

      <span id="topStatus" class="status"></span>
    </div>

    <!-- Tabs -->
    <div class="tabs">
      <button class="tab-btn active" data-tab="view-eval">Auswertung (aktuelle Runde)</button>
      <button class="tab-btn" data-tab="view-correct">Korrekte Antworten (alle Runden)</button>
      <button class="tab-btn" data-tab="view-sub">Abgaben (aktuelle Runde)</button>
    </div>

    <!-- View: Evaluation -->
    <section id="view-eval" class="view active">
      <div class="grid cols-2">
        <div class="card">
          <h2 style="margin:0 0 8px">Auswertung & Zusatzpunkte</h2>
          <p class="sub">Automatisch gezählt anhand „Korrekte Antworten“. Zusatzpunkte addieren sich dazu.</p>
          <div style="overflow:auto;">
            <table>
              <thead>
                <tr>
                  <th>Team</th>
                  <th class="center">Richtige</th>
                  <th class="center">Zusatz</th>
                  <th class="right">Rundenpunkte</th>
                </tr>
              </thead>
              <tbody id="evalBody"></tbody>
            </table>
          </div>
          <div style="display:flex; gap:10px; align-items:center; flex-wrap:wrap; margin-top:12px">
            <button class="btn ghost" id="recalcBtn">Neu berechnen</button>
            <button class="btn primary" id="saveScoresBtn">Punkte speichern</button>
            <span id="evalStatus" class="status"></span>
          </div>
        </div>

        <div class="card">
          <h2 style="margin:0 0 8px">Schnellübersicht Runde</h2>
          <table>
            <thead>
              <tr><th>Team</th><th class="right">Abgegeben</th><th>Uhrzeit</th></tr>
            </thead>
            <tbody id="submittedBody"></tbody>
          </table>
        </div>
      </div>
    </section>

    <!-- View: Correct Matrix -->
    <section id="view-correct" class="view">
      <div class="card">
        <h2 style="margin:0 0 8px">Korrekte Antworten (Runden 1–10 in einer Tabelle)</h2>
        <p class="sub">Varianten mit Semikolon trennen (z. B. <span class="mono">berlin; b</span>). „Alles speichern“ speichert jede Runde einzeln.</p>
        <div class="matrix">
          <table id="correctTable">
            <thead id="correctHead"></thead>
            <tbody id="correctBody"></tbody>
          </table>
        </div>
        <div style="display:flex; gap:10px; align-items:center; flex-wrap:wrap; margin-top:12px">
          <button class="btn primary" id="saveAllCorrectBtn">Alles speichern</button>
          <span id="corrStatus" class="status"></span>
        </div>
      </div>
    </section>

    <!-- View: Submissions detail -->
    <section id="view-sub" class="view">
      <div class="card">
        <h2 style="margin:0 0 8px">Antworten (aktuelle Runde)</h2>
        <div id="answersWrap"></div>
      </div>
    </section>
  </div>

  <!-- Bottom Active Bar -->
  <div class="activebar">
    <div class="row">
      <div class="legend">
        <b>Aktive Teams:</b> <span class="dot green"></span> sichtbar & ok
        • <span class="dot red"></span> Tab versteckt
        • <span class="dot gray"></span> unbekannt
      </div>
      <div id="activeList" style="display:flex; gap:8px; flex-wrap:wrap;"></div>
    </div>
  </div>

  <script>
    const MAX_ROUNDS = 10;
    const END_ROUND_VALUE = MAX_ROUNDS + 1; // "X (Ende)"

    // DOM
    const roundSel = document.getElementById('roundSel');
    const statusSel = document.getElementById('statusSel');
    const applyBtn  = document.getElementById('applyBtn');
    const openBtn   = document.getElementById('openBtn');
    const closeBtn  = document.getElementById('closeBtn');
    const liveBadge = document.getElementById('liveBadge');
    const topStatus = document.getElementById('topStatus');

    const tabBtns = document.querySelectorAll('.tab-btn');
    const views   = document.querySelectorAll('.view');

    const evalBody = document.getElementById('evalBody');
    const submittedBody = document.getElementById('submittedBody');
    const answersWrap = document.getElementById('answersWrap');
    const recalcBtn = document.getElementById('recalcBtn');
    const saveScoresBtn = document.getElementById('saveScoresBtn');
    const evalStatus = document.getElementById('evalStatus');

    const correctHead = document.getElementById('correctHead');
    const correctBody = document.getElementById('correctBody');
    const saveAllCorrectBtn = document.getElementById('saveAllCorrectBtn');
    const corrStatus = document.getElementById('corrStatus');

    const activeList = document.getElementById('activeList');

    // State
    let currentRound = 1;
    let closed = false;

    let teams = [];
    let scores = {};
    let correct = {}; // {round_1: {question_1:..}}
    let answersDb = {}; // all rounds
    let activeDb = []; // [{teamName, pageHidden, agoSec, active}]

    // Helpers
    function esc(s){ return (s??'').toString().replace(/[&<>"']/g,m=>({'&':'&amp;','<':'&gt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m])); }
    function setTop(t){ topStatus.textContent = t||''; setTimeout(()=> topStatus.textContent='', 2000); }
    function setEval(t){ evalStatus.textContent = t||''; setTimeout(()=> evalStatus.textContent='', 2000); }
    function setCorr(t){ corrStatus.textContent = t||''; setTimeout(()=> corrStatus.textContent='', 2000); }

    // Runden-Select: 0 (Start), 1..10, X (Ende)
    function buildRoundOptions(selected){
      roundSel.innerHTML = '';
      const opt0 = document.createElement('option'); opt0.value = 0; opt0.textContent = '0 – Start';
      roundSel.appendChild(opt0);
      for(let r=1;r<=MAX_ROUNDS;r++){
        const o = document.createElement('option'); o.value=r; o.textContent = 'Runde ' + r;
        roundSel.appendChild(o);
      }
      const optX = document.createElement('option'); optX.value = END_ROUND_VALUE; optX.textContent = 'X – Ende';
      roundSel.appendChild(optX);
      roundSel.value = String(selected);
    }

    // Tabs
    tabBtns.forEach(btn=>{
      btn.addEventListener('click', ()=>{
        tabBtns.forEach(b=>b.classList.remove('active'));
        views.forEach(v=>v.classList.remove('active'));
        btn.classList.add('active');
        document.getElementById(btn.dataset.tab).classList.add('active');
      });
    });

    // Loaders
    async function loadCore(){
      const cr = await fetch('/current-round').then(r=>r.json());
      currentRound = Number(cr.round||1);
      closed = !!cr.closed;
      // Falls Runde außerhalb 0..10 liegt, als "Ende" zeigen
      const sel = (currentRound<1) ? 0 : (currentRound>MAX_ROUNDS ? END_ROUND_VALUE : currentRound);
      buildRoundOptions(sel);
      statusSel.value = closed ? 'closed' : 'open';
      liveBadge.className = 'badge ' + (closed ? 'closed' : 'open');
      liveBadge.textContent = (sel===0) ? 'Start (0) – ' + (closed?'geschlossen':'offen')
        : (sel===END_ROUND_VALUE) ? 'Ende (X) – ' + (closed?'geschlossen':'offen')
        : `Runde ${sel} – ${closed?'geschlossen':'offen'}`;
    }
    async function loadAll(){
      const [t,s,c,a] = await Promise.all([
        fetch('/teams').then(r=>r.json()).catch(()=>[]),
        fetch('/scores').then(r=>r.json()).catch(()=>({})),
        fetch('/correct-answers').then(r=>r.json()).catch(()=>({})),
        fetch('/data/teamAnswers.json').then(r=>r.json()).catch(()=>({})),
      ]);
      teams=t; scores=s; correct=c; answersDb=a;
    }
    async function loadActive(){
      try{
        activeDb = await fetch('/admin/active-teams').then(r=>r.json());
      }catch{ activeDb=[]; }
      renderActiveBar();
    }

    // Renderers
    function renderEvaluation(){
      // compute per-team for currentRound (1..10 only)
      const r = Number(roundSel.value);
      const validRound = (r>=1 && r<=MAX_ROUNDS);
      evalBody.innerHTML = '';
      submittedBody.innerHTML = '';
      if(!validRound){
        evalBody.innerHTML = `<tr><td colspan="4" class="center"><span class="chip">Wähle eine Runde 1–${MAX_ROUNDS}</span></td></tr>`;
        submittedBody.innerHTML = `<tr><td colspan="3" class="center"><span class="chip">Keine Abgaben (Start/Ende)</span></td></tr>`;
        return;
      }

      const correctRow = correct[`round_${r}`] || {};
      const byTeam = answersDb[`round_${r}`] || {};
      const bonusMap = {}; // preserve edits across recalcs

      document.querySelectorAll('.bonus-input').forEach(inp=>{
        bonusMap[inp.dataset.team] = Number(inp.value||0);
      });

      const evalRows = [];
      const submitted = [];

      const teamSet = new Set([...teams, ...Object.keys(byTeam||{})]);
      for(const team of Array.from(teamSet).sort((a,b)=>a.localeCompare(b,'de'))){
        const entry = byTeam[team] || null;
        if(entry){
          const ts = entry.timestamp ? new Date(entry.timestamp).toLocaleTimeString() : '–';
          submitted.push({team, count: (entry.answers||[]).filter(v=>String(v||'').trim()).length, ts});
        }
        let correctCount = 0;
        const ans = (entry?.answers) || [];
        for(let i=1;i<=12;i++){
          const ok = (correctRow[`question_${i}`] || '').split(';').map(x=>x.trim().toLowerCase()).filter(Boolean);
          const u  = String(ans[i-1]||'').trim().toLowerCase();
          if(u && ok.includes(u)) correctCount++;
        }
        const bonus = bonusMap[team] ?? (Number(scores[team]?.extra_round?.[`Runde ${r}`]||0));
        evalRows.push({team, correctCount, bonus, total: correctCount + (Number(bonus)||0)});
      }

      // render table
      for(const row of evalRows){
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${esc(row.team)}</td>
          <td class="center"><span class="chip ${row.correctCount? 'ok':'no'}">${row.correctCount}</span></td>
          <td class="center">
            <input type="number" step="0.5" value="${row.bonus||0}" data-team="${esc(row.team)}" class="bonus-input" style="width:80px;text-align:center" />
          </td>
          <td class="right"><b>${row.total}</b></td>
        `;
        evalBody.appendChild(tr);
      }

      // submitted table
      for(const s of submitted){
        const tr = document.createElement('tr');
        tr.innerHTML = `<td>${esc(s.team)}</td><td class="right">${s.count} / 12</td><td>${esc(s.ts)}</td>`;
        submittedBody.appendChild(tr);
      }
      if(submitted.length===0){
        submittedBody.innerHTML = `<tr><td colspan="3" class="center"><span class="chip">Keine Abgaben</span></td></tr>`;
      }
    }

    function renderAnswersDetail(){
      const r = Number(roundSel.value);
      const byTeam = answersDb[`round_${r}`] || {};
      const container = document.createElement('div');
      for(const team of teams.slice().sort((a,b)=>a.localeCompare(b,'de'))){
        const entry = byTeam[team];
        const div = document.createElement('div');
        div.style.marginBottom='10px';
        div.innerHTML = `<b>${esc(team)}</b>: `;
        if(!entry){ div.innerHTML += '<span class="sub">keine Abgabe</span>'; }
        else{
          (entry.answers||[]).forEach((a,i)=>{
            const ok = (correct[`round_${r}`]?.[`question_${i+1}`]||'').split(';').map(x=>x.trim().toLowerCase());
            const good = ok.includes(String(a||'').trim().toLowerCase());
            div.innerHTML += `<span class="chip ${good?'ok':'no'} mono">${i+1}: ${esc(a||'')}</span> `;
          });
        }
        container.appendChild(div);
      }
      answersWrap.innerHTML = '';
      answersWrap.appendChild(container);
    }

    function buildCorrectMatrix(){
      // head
      correctHead.innerHTML = '';
      const trh = document.createElement('tr');
      const th0 = document.createElement('th'); th0.textContent='Runde'; th0.className='sticky-left'; trh.appendChild(th0);
      for(let q=1;q<=12;q++){ const th=document.createElement('th'); th.textContent='F'+q; trh.appendChild(th); }
      correctHead.appendChild(trh);

      // body rows 1..10
      correctBody.innerHTML = '';
      for(let r=1;r<=MAX_ROUNDS;r++){
        const tr = document.createElement('tr');
        const tl = document.createElement('td'); tl.textContent='Runde '+r; tl.className='sticky-left'; tr.appendChild(tl);
        const row = correct[`round_${r}`] || {};
        for(let q=1;q<=12;q++){
          const td = document.createElement('td');
          const inp = document.createElement('input');
          inp.value = row[`question_${q}`] || '';
          inp.dataset.round = r; inp.dataset.q = q;
          td.appendChild(inp); tr.appendChild(td);
        }
        correctBody.appendChild(tr);
      }
    }

    function renderActiveBar(){
      const map = new Map(); // team -> {color}
      // start gray
      teams.forEach(t => map.set(t, {color:'gray'}));
      // overlay with activeDb
      for(const row of (activeDb||[])){
        const t = row.teamName;
        if(!map.has(t)) map.set(t,{color:'gray'});
        // Regel: pageHidden true -> rot; sonst grün (auch wenn agoSec hoch)
        map.get(t).color = row.pageHidden ? 'red' : 'green';
      }

      activeList.innerHTML = '';
      const sorted = Array.from(map.entries()).sort((a,b)=>a[0].localeCompare(b[0],'de'));
      for(const [team,info] of sorted){
        const pill = document.createElement('span');
        pill.className = 'team-pill';
        pill.innerHTML = `<span class="dot ${info.color}"></span>${esc(team)}`;
        activeList.appendChild(pill);
      }
    }

    // Actions
    async function applyRound(closedOverride = null){
      const sel = Number(roundSel.value);
      const roundToSet = (sel===0) ? 0 : (sel===END_ROUND_VALUE ? (MAX_ROUNDS+1) : sel);
      const closedVal = (closedOverride===null) ? (statusSel.value==='closed') : !!closedOverride;
      await fetch('/current-round', {
        method:'POST', headers:{'Content-Type':'application/json'},
        body: JSON.stringify({ round: roundToSet, closed: closedVal })
      });
      await loadCore();
      setTop('Gespeichert.');
    }

    async function saveScores(){
      // Merge: vorhandene Scores + aktuelle Runde-Bewertung + Extra pro Runde
      const existing = await fetch('/scores').then(r=>r.json()).catch(()=>({}));
      const r = Number(roundSel.value);
      if(!(r>=1 && r<=MAX_ROUNDS)){ setEval('Wähle Runde 1–'+MAX_ROUNDS); return; }

      // read table values again
      const bonusMap = {};
      document.querySelectorAll('.bonus-input').forEach(inp=>{
        bonusMap[inp.dataset.team] = Number(inp.value||0);
      });

      const byTeam = answersDb[`round_${r}`] || {};
      const correctRow = correct[`round_${r}`] || {};

      for(const team of new Set([...teams, ...Object.keys(byTeam)])){
        const entry = byTeam[team] || {};
        const ans = entry.answers || [];
        let count = 0;
        for(let i=1;i<=12;i++){
          const ok = (correctRow[`question_${i}`]||'').split(';').map(x=>x.trim().toLowerCase()).filter(Boolean);
          const u = String(ans[i-1]||'').trim().toLowerCase();
          if(u && ok.includes(u)) count++;
        }
        const total = count + (Number(bonusMap[team])||0);
        existing[team] = existing[team] || {};
        existing[team][`Runde ${r}`] = total;
        // zusätzlich speichern wir optional pro-Runde-Extra separat
        existing[team].extra_round = existing[team].extra_round || {};
        existing[team].extra_round[`Runde ${r}`] = Number(bonusMap[team])||0;
      }

      await fetch('/save-scores', {
        method:'POST', headers:{'Content-Type':'application/json'},
        body: JSON.stringify(existing)
      });
      setEval('Punkte gespeichert.');
    }

    async function saveAllCorrect(){
      // iteriere Runden 1..MAX_ROUNDS und poste jeweils die Zeile
      const payloadPerRound = {};
      document.querySelectorAll('#correctBody input').forEach(inp=>{
        const r = Number(inp.dataset.round), q = Number(inp.dataset.q);
        payloadPerRound[r] = payloadPerRound[r] || {};
        payloadPerRound[r][`question_${q}`] = inp.value || '';
      });

      for(const r of Object.keys(payloadPerRound).map(n=>+n).sort((a,b)=>a-b)){
        await fetch('/save-correct-answers', {
          method:'POST', headers:{'Content-Type':'application/json'},
          body: JSON.stringify({ round: r, correctAnswers: payloadPerRound[r] })
        });
      }
      // reload local cache
      correct = await fetch('/correct-answers').then(r=>r.json()).catch(()=>({}));
      setCorr('Alle Runden gespeichert.');
    }

    // Events
    applyBtn.addEventListener('click', ()=> applyRound(null));
    openBtn.addEventListener('click', ()=> { statusSel.value='open'; applyRound(false); });
    closeBtn.addEventListener('click', ()=> { statusSel.value='closed'; applyRound(true); });
    recalcBtn.addEventListener('click', ()=> { renderEvaluation(); setEval('Neu berechnet.'); });
    saveScoresBtn.addEventListener('click', saveScores);
    saveAllCorrectBtn.addEventListener('click', saveAllCorrect);
    roundSel.addEventListener('change', ()=> { renderEvaluation(); renderAnswersDetail(); });

    // Init
    (async function init(){
      await loadCore();
      await loadAll();
      buildCorrectMatrix();
      renderEvaluation();
      renderAnswersDetail();
      await loadActive();
      setInterval(loadActive, 4000); // Bottom-Bar live
    })();
  </script>
</body>
</html>