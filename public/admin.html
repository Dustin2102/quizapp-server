<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8" />
  <title>Admin Panel</title>
  <style>
    :root{
      --ok:#c8f7c5; --no:#f8d7da; --line:#bbb; --muted:#666;
      --accent:#00a86b; --warn:#ff9800; --danger:#dc3545;
    }
    *{box-sizing:border-box}
    body{font-family: Arial, sans-serif; margin:20px}
    h1{margin:0 0 10px}
    h2{margin:24px 0 8px}
    button{margin:4px; padding:.6rem 1.0rem; cursor:pointer; border:none; border-radius:8px}
    .btn{background:#e9ecef}
    .btn.primary{background:var(--accent); color:#fff}
    .btn.warn{background:var(--warn); color:#fff}
    .btn.danger{background:var(--danger); color:#fff}
    select{padding:.5rem .7rem; border:1px solid #ccc; border-radius:8px}

    #qrButton{
      position:fixed; top:10px; right:10px;
      background:#008000; color:#fff; border:none; padding:.6rem 1.2rem;
      border-radius:8px; cursor:pointer; font-weight:bold;
      box-shadow:0 2px 6px rgba(0,0,0,.2)
    }
    #qrButton:hover{background:#006400}
    #teamCounter{
      position:fixed; top:56px; right:10px; z-index:2;
      font-weight:bold; background:#f0f0f0; padding:.3rem .6rem;
      border-radius:6px; border:1px solid #ccc;
    }

    table{border-collapse:collapse; margin:12px 0; width:100%; max-width:1200px}
    th,td{border:1px solid var(--line); padding:8px; text-align:center}
    th{background:#f0f0f0; position:sticky; top:0}
    .ok{background:var(--ok)} .no{background:var(--no); cursor:pointer}
    .hint{font-size:.92rem; color:var(--muted); margin:6px 0 10px}

    .round-header td{
      background:#eef7ff; font-weight:bold; text-align:left; border-top:3px solid #89bfff;
    }
    .answers-input{width:100%; max-width:520px; padding:.4rem; border:1px solid #ccc; border-radius:6px; text-align:left}

    .flex{display:flex; align-items:center; gap:.5rem; flex-wrap:wrap}
    .spacer{flex:1}
  </style>
</head>
<body>
  <h1>Admin Panel</h1>
  <button id="qrButton" onclick="window.open('qr.html','_blank')">QR-Code</button>
  <div id="teamCounter">Teams: 0</div>

  <h2>Rundensteuerung</h2>
  <div class="flex">
    <div>Aktuell: <strong id="aktuelleRunde">0</strong> <span id="rundenStatus" style="color:#666"></span></div>
    <div class="spacer"></div>
    <label for="roundPicker">Ziel-Runde:</label>
    <select id="roundPicker">
      <option value="0">0 – Warten</option>
      <option value="1">1 – Runde 1</option>
      <option value="2">2 – Runde 2</option>
      <option value="3">3 – Runde 3</option>
      <option value="4">4 – Runde 4</option>
      <option value="5">5 – Runde 5</option>
      <option value="6">6 – Runde 6</option>
      <option value="7">7 – Ende</option>
    </select>
    <button class="btn primary" onclick="setSelectedRoundOpen()">Setzen & öffnen</button>
    <button class="btn warn" onclick="closeCurrent()">Nur schließen</button>
    <button class="btn danger" onclick="resetEverything()">Alles zurücksetzen</button>
  </div>

  <h2>Punktetabelle (Gesamt)</h2>
  <div id="punkteTabelle"></div>

  <h2>Auswertung (aktuelle Runde)</h2>
  <p class="hint">Auf eine <strong>rote Zelle</strong> klicken, um diese Schreibweise als <em>korrekt</em> zu übernehmen – die Tabelle rechnet sofort neu.</p>
  <div id="auswertung"></div>

  <h2>Richtige Antworten – Übersicht & Bearbeitung</h2>
  <p class="hint">Mehrere Varianten mit <code>,</code>/<code>;</code>/<code>|</code> trennen (z. B. <em>Berlin; Bärlin | Hauptstadt</em>).</p>
  <div id="answersGrid"></div>

  <h2>Teams</h2>
  <ul id="teamList"></ul>

  <script>
    let state = { round: 0, closed: false };

    /* ---- Unicode-sichere Base64 ---- */
    const b64enc = (str) => btoa(unescape(encodeURIComponent(str)));
    const b64dec = (b64) => decodeURIComponent(escape(atob(b64)));

    /* ---- Fetch Helper mit Cache-Buster & Fehlerwurf ---- */
    async function getJSON(url){
      const res = await fetch(url + (url.includes('?')?'&':'?') + '_=' + Date.now());
      if(!res.ok) throw new Error(url + ' -> ' + res.status);
      return res.json();
    }
    async function postJSON(url, body){
      const res = await fetch(url, {
        method: "POST",
        headers: { "Content-Type":"application/json" },
        body: JSON.stringify(body)
      });
      if(!res.ok) throw new Error(url + ' -> ' + res.status);
      return res;
    }

    /* ---- Helpers ---- */
    const normalizeCorrect = (val) => {
      if (Array.isArray(val)) return val.map(v => String(v).trim()).filter(Boolean);
      if (typeof val === "string") return val.split(/[;,|]/g).map(s => s.trim()).filter(Boolean);
      return [];
    };
    const escapeAttr = (v) => String(v).replace(/"/g, "&quot;");

    /* ---- Round control ---- */
    async function fetchRound() {
      const data = await getJSON("/current-round");
      state.round = +data.round || 0; state.closed = !!data.closed;
      document.getElementById("aktuelleRunde").textContent = state.round;
      document.getElementById("rundenStatus").textContent = state.closed ? "(geschlossen)" : "(offen)";
      document.getElementById("roundPicker").value = String(state.round);
    }
    async function setRound(round, closed) {
      await postJSON("/current-round", { round, closed: !!closed });
      await fetchRound();
      await lightRefresh();
    }
    function setSelectedRoundOpen() {
      const r = parseInt(document.getElementById("roundPicker").value);
      setRound(r, false);
    }
    function closeCurrent() { setRound(state.round, true); }

    async function resetEverything() {
      const ok = confirm("Wirklich ALLES zurücksetzen? (Teams, Antworten, Punkte; Runde → 0)");
      if (!ok) return;
      await postJSON("/reset-teams", {});
      await fetchRound();
      await heavyRefresh();
      alert("Zurückgesetzt.");
    }

    /* ---- Scores & Teams ---- */
    async function loadScores() {
      const scores = await getJSON("/scores");
      const teams  = await getJSON("/teams");
      document.getElementById("teamCounter").textContent = "Teams: " + teams.length;

      function totalFor(team) {
        const s = scores[team];
        if (typeof s === "number") return s;
        if (s && typeof s === "object") return Object.values(s).reduce((a,b)=>a+(+b||0),0);
        return 0;
      }
      const rows = teams.map(t => ({ team: t, sum: totalFor(t) }))
                        .sort((a,b)=>b.sum-a.sum);

      let html = "<table><tr><th>Platz</th><th>Team</th><th>Punkte</th></tr>";
      rows.forEach((r,i)=> html += `<tr><td>${i+1}</td><td>${r.team}</td><td>${r.sum}</td></tr>`);
      html += "</table>";
      document.getElementById("punkteTabelle").innerHTML = html;

      const ul = document.getElementById("teamList"); ul.innerHTML="";
      teams.forEach(t => { const li=document.createElement("li"); li.textContent=t; ul.appendChild(li); });
    }

    /* ---- Korrekte Antworten lesen (Array+Objekt kompatibel) ---- */
    function getCorrectListForQuestion(corrRound, qIndex) {
      if (!corrRound) return [];
      const objVal = corrRound[`question_${qIndex}`];
      if (typeof objVal !== "undefined") return normalizeCorrect(objVal);
      const arrVal = corrRound[qIndex - 1];
      return normalizeCorrect(arrVal);
    }

    /* ---- Auswertung mit Click-to-Correct (Base64-sicher) ---- */
    async function loadEvaluation() {
      await fetchRound();
      const r = state.round, target = document.getElementById("auswertung");
      if (r < 1 || r > 6) { target.innerHTML = "<p style='color:#666'>Keine Auswertung verfügbar.</p>"; return; }

      const ansData  = await getJSON("/data/teamAnswers.json");
      const corrData = await getJSON("/correct-answers");
      const scoresData = await getJSON("/scores");

      const rAnswers = ansData[`round_${r}`] || {};
      const corrRound = corrData[`round_${r}`] || {};

      let html = `<table><tr><th>Team</th>${Array.from({length:12},(_,i)=>`<th>${i+1}</th>`).join('')}<th>Zeit</th></tr>`;
      const punkteMap = {};

      for (const team in rAnswers) {
        const entry = rAnswers[team];
        const a = entry.answers || [];
        const ts = new Date(entry.timestamp).toLocaleString("de-DE");
        let punkte=0, row=`<td>${team}</td>`;

        for (let i = 0; i < 12; i++) {
          const ua = (a[i] || "").toString().trim();
          const list = getCorrectListForQuestion(corrRound, i+1);
          const isOk = list.some(c => c.toLowerCase().trim() === ua.toLowerCase().trim());
          if (isOk) punkte++;

          const uaB64 = b64enc(ua);
          row += `<td class="${isOk?'ok':'no'}"
                      data-round="${r}" data-q="${i+1}" data-ua="${uaB64}"
                      title="${isOk?'':'Klicken: Schreibweise als korrekt übernehmen'}">
                   ${ua || "&nbsp;"}<br>${isOk?'✅':'❌'}
                  </td>`;
        }
        row += `<td>${ts}</td>`;
        html += `<tr>${row}</tr>`;
        punkteMap[team] = punkte;
      }
      html += "</table>";
      target.innerHTML = html;

      // Click-to-correct (Base64 decode) + Fehlerfeedback
      target.querySelectorAll("td.no").forEach(td=>{
        td.addEventListener("click", async ()=>{
          try{
            const rr = Number(td.dataset.round), q = Number(td.dataset.q);
            const ua = b64dec(td.dataset.ua || "");
            if (!ua) return;
            const ok = confirm(`„${ua}“ als KORREKT für Runde ${rr}, Frage ${q} übernehmen?`);
            if (!ok) return;
            await addVariantToCorrect(rr, q, ua);
            await loadEvaluation();
            await loadScores();
            // optional: kurzes visuelles Feedback
          }catch(err){
            alert("Konnte nicht speichern: " + err.message);
            console.error(err);
          }
        });
      });

      // Scores mergen & speichern
      for (const team in punkteMap) {
        if (!scoresData[team]) scoresData[team] = {};
        scoresData[team][`Runde ${r}`] = punkteMap[team];
      }
      await postJSON("/save-scores", scoresData);
    }

    async function addVariantToCorrect(round, question, newVar) {
      // aktuelle Liste holen
      const corr = await getJSON("/correct-answers");
      const keyR = `round_${round}`, keyQ = `question_${question}`;
      let prev = corr[keyR] || {};
      let curr = (typeof prev[keyQ] !== "undefined") ? prev[keyQ] : prev[question - 1];
      let list = normalizeCorrect(curr);

      if (!list.some(v => v.toLowerCase().trim() === newVar.toLowerCase().trim())) list.push(newVar);
      const joined = list.join(", ");

      // Speichern + Fehler prüfen
      await postJSON("/update-correct-answer", { round, question, answer: joined });
    }

    /* ---- Richtige Antworten Grid ---- */
    async function loadAnswersGrid() {
      const data = await getJSON("/correct-answers");
      let html = `<table><thead><tr><th style="width:120px">Runde</th><th style="width:120px">Frage</th><th>Richtige Antwort(en)</th></tr></thead><tbody>`;
      for (let r = 1; r <= 6; r++) {
        html += `<tr class="round-header"><td colspan="3">Runde ${r}</td></tr>`;
        const round = data[`round_${r}`] || {};
        for (let q = 1; q <= 12; q++) {
          const rawObj = round[`question_${q}`];
          const rawArr = round[q - 1];
          const val = rawObj ?? rawArr ?? "";
          const show = Array.isArray(val) ? val.join(", ") : String(val);
          html += `<tr>
            <td>Runde ${r}</td>
            <td>Frage ${q}</td>
            <td style="text-align:left">
              <input class="answers-input" type="text"
                     value="${escapeAttr(show)}"
                     data-round="${r}" data-question="${q}"
                     placeholder="z.B. Berlin; Bärlin | Hauptstadt" />
            </td>
          </tr>`;
        }
      }
      html += `</tbody></table>`;
      const wrap = document.getElementById("answersGrid");
      wrap.innerHTML = html;

      wrap.querySelectorAll(".answers-input").forEach(inp=>{
        inp.addEventListener("blur", onSaveAnswerCell);
        inp.addEventListener("keydown", e=>{ if(e.key==="Enter"){ e.preventDefault(); inp.blur(); } });
      });
    }

    async function onSaveAnswerCell(e) {
      try{
        const el = e.target;
        const round = Number(el.dataset.round), question = Number(el.dataset.question), answer = el.value.trim();
        await postJSON("/update-correct-answer", { round, question, answer });
      }catch(err){
        alert("Konnte nicht speichern: " + err.message);
        console.error(err);
      }
    }

    async function heavyRefresh() {
      await fetchRound();
      await Promise.all([loadScores(), loadEvaluation(), loadAnswersGrid()]);
    }
    async function lightRefresh() {
      await Promise.all([loadScores(), loadEvaluation()]);
    }

    // init + Poll
    heavyRefresh();
    setInterval(lightRefresh, 5000);
  </script>
</body>
</html>