<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8" />
  <title>Reveal & Zwischenstand</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="stylesheet" href="style.css" />
  <style>
    :root{
      --fg:#0f172a; --muted:#64748b;
      --border:#e5e7eb; --card:#fff; --bg:#f6f8fb; --shadow:0 8px 24px rgba(2,6,23,.12);
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0; font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
      color:var(--fg); background:linear-gradient(180deg,#fff,var(--bg));
      min-height:100dvh;
    }
    .wrap{ width:min(1200px,96vw); margin:22px auto 40px; }
    h1{ margin:0 0 6px; }
    .sub{ color:var(--muted); margin:0 0 14px; }

    .card{ background:var(--card); border:1px solid var(--border); border-radius:16px; padding:16px; box-shadow:var(--shadow); margin-top:16px; overflow:auto; }
    table{ width:100%; border-collapse:collapse; font-size:16px; }
    thead th{ position:sticky; top:0; background:#f8fafc; border-bottom:1px solid var(--border); padding:10px; text-align:left; }
    tbody td{ border-bottom:1px solid #eef2f7; padding:10px; vertical-align:top; }
    .right{text-align:right}
    .rank{ font-weight:900; width:60px; }

    /* Dock oben rechts */
    .dock{
      position:fixed; right:14px; top:14px; z-index:40;
      background:#ffffffee; backdrop-filter: blur(6px);
      border:1px solid var(--border); border-radius:12px; box-shadow:var(--shadow);
      padding:8px; display:flex; flex-direction:column; gap:6px; width:auto; min-width:auto;
    }
    .dock .row{ display:flex; gap:6px; flex-wrap:wrap; align-items:center; }
    .dock button{
      padding:8px 12px; border:1px solid var(--border); border-radius:8px; background:#fff; cursor:pointer; font-weight:800; font-size:13px;
      /* Texte immer sichtbar – überschreibt evtl. globales CSS */
      color:#0f172a !important; -webkit-text-fill-color:#0f172a !important; background-image:none !important; text-shadow:none !important;
    }
    .dock button.primary{ background:linear-gradient(135deg,#22c55e,#16a34a) !important; border:none !important; color:#fff !important; -webkit-text-fill-color:#fff !important; }
    .dock button.warn{ background:linear-gradient(135deg,#f59e0b,#d97706) !important; border:none !important; color:#fff !important; -webkit-text-fill-color:#fff !important; }
    .dock label{ font-weight:600; display:flex; align-items:center; gap:6px; font-size:13px; }
    .dock small{ color:var(--muted); font-size:12px; }
    @media (max-width:640px){ .dock{ left:14px; right:14px; top:auto; bottom:14px; } }

    /* Feuerwerk */
    #fx{ position:fixed; inset:0; pointer-events:none; z-index:30; display:none; }
  </style>
</head>
<body>
  <canvas id="fx"></canvas>

  <div class="dock">
    <div class="row">
      <button class="primary" id="btnReload">Neu laden</button>
      <button id="btnFull">Vollbild</button>
      <button class="warn" id="btnFireworks">Feuerwerk</button>
    </div>
    <div class="row">
      <label><input type="checkbox" id="cbAuto" /> Auto (5s)</label>
      <label><input type="checkbox" id="cbRounds" checked /> Rundenpunkte</label>
      <button id="btnSortName">A–Z</button>
      <button id="btnSortTotal">Σ</button>
    </div>
    <small id="dockInfo"></small>
  </div>

  <div class="wrap">
    <h1>Reveal & Zwischenstand</h1>
    <p class="sub">Volle Rangliste ab Platz 1. Steuerung immer sichtbar in der Dock.</p>

    <div class="card">
      <table id="tbl">
        <thead id="thead"></thead>
        <tbody id="tbody"></tbody>
      </table>
    </div>
  </div>

  <script>
    const MAX_ROUNDS = 10;
    const thead = document.getElementById('thead');
    const tbody = document.getElementById('tbody');
    const cbAuto = document.getElementById('cbAuto');
    const cbRounds = document.getElementById('cbRounds');
    const btnReload = document.getElementById('btnReload');
    const btnSortTotal = document.getElementById('btnSortTotal');
    const btnSortName = document.getElementById('btnSortName');
    const btnFull = document.getElementById('btnFull');
    const btnFireworks = document.getElementById('btnFireworks');
    const dockInfo = document.getElementById('dockInfo');

    let allScores = {}, allTeams = [], sortMode = 'total', timer = null;

    function sumTeam(team){ let s=0; for(let r=1;r<=MAX_ROUNDS;r++) s += Number(allScores?.[team]?.[`Runde ${r}`]||0); return s; }

    function buildHead(){
      thead.innerHTML = '';
      const tr = document.createElement('tr');
      tr.innerHTML = '<th>#</th><th>Team</th><th class="right">Gesamt</th>';
      if (cbRounds.checked){
        for(let r=1;r<=MAX_ROUNDS;r++){ const th=document.createElement('th'); th.textContent='R '+r; th.className='right'; tr.appendChild(th); }
      }
      thead.appendChild(tr);
    }

    function render(){
      buildHead();
      const set = new Set([...allTeams, ...Object.keys(allScores||{})]);
      let rows = Array.from(set);
      rows.sort(sortMode==='name' ? (a,b)=>a.localeCompare(b,'de') : (a,b)=>sumTeam(b)-sumTeam(a)||a.localeCompare(b,'de'));

      const totals = rows.map(t=>({team:t,total:sumTeam(t)}));
      const places = new Map(); let prev=null, place=0;
      totals.forEach((x,i)=>{ if(prev===null || x.total<prev) place=i+1; places.set(x.team,place); prev=x.total; });

      tbody.innerHTML='';
      for(const team of rows){
        const tr = document.createElement('tr');
        tr.innerHTML = `<td class="rank">${places.get(team)}</td><td>${team}</td><td class="right"><b>${sumTeam(team)}</b></td>`;
        if (cbRounds.checked){
          for(let r=1;r<=MAX_ROUNDS;r++){ const v = Number(allScores?.[team]?.[`Runde ${r}`]||0); const td=document.createElement('td'); td.className='right'; td.textContent=v? v : '–'; tr.appendChild(td); }
        }
        tbody.appendChild(tr);
      }
      dockInfo.textContent = `${rows.length} Teams • Sortierung: ${sortMode==='total'?'Gesamt':'A–Z'}`;
    }

    async function loadAll(){
      const [teams, scores] = await Promise.all([ fetch('/teams').then(r=>r.json()).catch(()=>[]), fetch('/scores').then(r=>r.json()).catch(()=>({})) ]);
      allTeams = Array.isArray(teams)?teams:[]; allScores = (scores&&typeof scores==='object')?scores:{};
    }

    async function refresh(){ clearTimeout(timer); await loadAll(); render(); if(cbAuto.checked) timer=setTimeout(refresh,5000); }

    btnReload.addEventListener('click', refresh);
    btnSortTotal.addEventListener('click', ()=>{ sortMode='total'; render(); });
    btnSortName.addEventListener('click', ()=>{ sortMode='name'; render(); });
    cbRounds.addEventListener('change', render);
    cbAuto.addEventListener('change', refresh);
    btnFull.addEventListener('click', ()=>{ const el=document.documentElement; if(!document.fullscreenElement) el.requestFullscreen?.(); else document.exitFullscreen?.(); });

    // Feuerwerk (leicht)
    const fx=document.getElementById('fx'), ctx=fx.getContext('2d'); function size(){ fx.width=innerWidth; fx.height=innerHeight; } addEventListener('resize',size); size();
    let fwTimer=null, parts=[];
    function rnd(a,b){return Math.random()*(b-a)+a}
    function burst(){ const x=rnd(0.2*fx.width,0.8*fx.width), y=rnd(0.2*fx.height,0.5*fx.height), colors=['#fbbf24','#60a5fa','#f472b6','#34d399','#f87171','#a78bfa']; for(let i=0;i<100;i++){ const ang=Math.random()*Math.PI*2, sp=rnd(2,6); parts.push({x,y,vx:Math.cos(ang)*sp,vy:Math.sin(ang)*sp,l:rnd(60,120),c:colors[(Math.random()*colors.length)|0],g:0.05,d:0.99,s:rnd(2,4)});} }
    function step(){ ctx.clearRect(0,0,fx.width,fx.height); parts.forEach(p=>{p.vx*=p.d; p.vy=p.vy*p.d+p.g; p.x+=p.vx; p.y+=p.vy; p.l--; ctx.globalAlpha=Math.max(p.l/120,0); ctx.fillStyle=p.c; ctx.beginPath(); ctx.arc(p.x,p.y,p.s,0,Math.PI*2); ctx.fill();}); parts=parts.filter(p=>p.l>0); if(parts.length>0||fwTimer) requestAnimationFrame(step); }
    function fireworks(ms=6000){ fx.style.display='block'; burst(); fwTimer=setInterval(burst,700); step(); setTimeout(()=>{ clearInterval(fwTimer); fwTimer=null; setTimeout(()=>fx.style.display='none',1500); },ms); }
    btnFireworks.addEventListener('click', ()=>fireworks(6000));

    refresh();
  </script>
</body>
</html>