<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8" />
  <title>Reveal – Platz für Platz mit Feuerwerk</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="stylesheet" href="style.css" />
  <style>
    :root{
      --fg:#0f172a; --muted:#64748b; --accent:#3b82f6;
      --bg-from:#ffffff; --bg-to:#f6f8fb; --card:#ffffff;
      --ring: rgba(59,130,246,.18); --border:#e5e7eb; --shadow:0 6px 20px rgba(2,6,23,.08);
    }
    html,body{height:100%}
    body{
      margin:0; padding:0; font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
      color:var(--fg); background:linear-gradient(180deg,var(--bg-from),var(--bg-to));
      min-height:100dvh; overflow-x:hidden;
    }
    .wrap{ width:min(1100px,96vw); margin:28px auto 40px; position:relative; z-index:1; }
    h1{ margin:0 0 6px; }
    .sub{ color:var(--muted); margin:0 0 16px; }

    .toolbar{
      display:flex; flex-wrap:wrap; gap:10px; align-items:center;
      background:var(--card); border:1px solid var(--border); border-radius:14px; padding:12px; box-shadow:var(--shadow);
      position:sticky; top:0; z-index:3;
    }
    .toolbar > *{ margin-right:8px; }
    .btn{ padding:10px 14px; border:1px solid var(--border); border-radius:10px; background:#fff; cursor:pointer; }
    .btn:hover{ filter:saturate(1.05); }
    .btn:disabled{ opacity:.5; cursor:not-allowed; }
    select, input{
      padding:10px 12px; border:1px solid var(--border); border-radius:10px; outline:none;
    }
    select:focus, input:focus{ box-shadow:0 0 0 4px var(--ring); }
    .card{
      background:var(--card); border:1px solid var(--border); border-radius:16px; padding:16px; box-shadow:var(--shadow);
      margin-top:14px; overflow:hidden;
    }

    .stage{
      display:flex; align-items:center; justify-content:center; min-height:280px;
      background:linear-gradient(180deg,#f8fafc,#fff);
      border:1px dashed var(--border); border-radius:14px;
    }
    .revealBox{
      text-align:center; padding:28px 20px; border-radius:14px;
      background:#fff; box-shadow:0 10px 28px rgba(2,6,23,.08); border:1px solid var(--border);
      min-width:min(680px, 96%);
    }
    .pos{ font-size:44px; font-weight:900; letter-spacing:.5px; margin:0; }
    .team{ font-size:32px; font-weight:800; margin:6px 0 0; }
    .pts{ font-size:20px; color:#0f172a; margin:6px 0 0; }

    .grid{ width:100%; overflow:auto; }
    table{ width:100%; border-collapse:collapse; font-size:14px; }
    thead th{
      position:sticky; top:0; background:#f8fafc; border-bottom:1px solid var(--border);
      text-align:left; padding:10px; font-weight:700;
    }
    tbody td{ border-bottom:1px solid #eef2f7; padding:9px 10px; }
    .right{text-align:right}
    .total{ font-weight:800; }
    .muted{ color:var(--muted); }

    /* Canvas overlay for fireworks */
    #fx{
      position:fixed; inset:0; pointer-events:none; z-index:2; display:none;
    }
  </style>
</head>
<body>
  <canvas id="fx"></canvas>

  <div class="wrap">
    <h1>Platz-für-Platz Reveal</h1>
    <p class="sub">Vom letzten Platz bis zum <strong>1.</strong> – mit Feuerwerk für den Sieger. Danach Gesamtübersicht.</p>

    <div class="toolbar">
      <label>Max. Runden:
        <select id="maxRounds">
          <option value="6">6</option>
          <option value="7">7</option>
          <option value="8">8</option>
          <option value="9">9</option>
          <option value="10" selected>10</option>
        </select>
      </label>

      <button class="btn" id="loadBtn">Daten laden</button>
      <button class="btn" id="startBtn" disabled>Reveal starten</button>
      <button class="btn" id="nextBtn" disabled>Weiter</button>
      <button class="btn" id="showAllBtn" disabled>Gesamtübersicht</button>

      <span id="status" class="muted"></span>
    </div>

    <div class="card">
      <div class="stage" id="stage">
        <div class="revealBox" id="box" style="display:none">
          <p class="pos" id="pos">Platz –</p>
          <p class="team" id="team">—</p>
          <p class="pts" id="pts">Gesamtpunkte: –</p>
        </div>
        <div id="hint" class="muted">Klicke oben auf „Daten laden“.</div>
      </div>

      <div class="grid" id="tableWrap" style="display:none; margin-top:14px;">
        <table>
          <thead id="thead"></thead>
          <tbody id="tbody"></tbody>
        </table>
      </div>
    </div>
  </div>

  <script>
    // ===== DOM =====
    const fx = document.getElementById('fx');
    const statusEl = document.getElementById('status');
    const loadBtn = document.getElementById('loadBtn');
    const startBtn = document.getElementById('startBtn');
    const nextBtn = document.getElementById('nextBtn');
    const showAllBtn = document.getElementById('showAllBtn');
    const stage = document.getElementById('stage');
    const box = document.getElementById('box');
    const posEl = document.getElementById('pos');
    const teamEl = document.getElementById('team');
    const ptsEl = document.getElementById('pts');
    const hint = document.getElementById('hint');
    const tableWrap = document.getElementById('tableWrap');
    const thead = document.getElementById('thead');
    const tbody = document.getElementById('tbody');
    const maxRoundsSel = document.getElementById('maxRounds');

    // ===== State =====
    let rows = [];        // [{team, sum, perRound:[...]}] sorted desc
    let idx = null;       // reveal index from last to 0
    let maxRounds = 10;

    function status(t){ statusEl.textContent = t; }
    function esc(s){ return s.replace(/[&<>"']/g, m=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m])); }

    // ===== Data loading =====
    async function fetchJson(url, fallback){
      try{ const r = await fetch(url); if(!r.ok) throw 0; return await r.json(); }catch{ return fallback; }
    }

    async function loadData(){
      startBtn.disabled = true; nextBtn.disabled = true; showAllBtn.disabled = true;
      tableWrap.style.display = 'none'; box.style.display = 'none'; hint.style.display = '';
      status('Lade …');

      maxRounds = parseInt(maxRoundsSel.value,10);
      const [scores, teams] = await Promise.all([
        fetchJson('/scores', {}),
        fetchJson('/teams', [])
      ]);

      // Build set of all team names
      const set = new Set(teams);
      Object.keys(scores||{}).forEach(t => set.add(t));

      const arr = [];
      for(const team of Array.from(set)){
        const perRound = [];
        let sum = 0;
        for(let r=1;r<=maxRounds;r++){
          const v = Number((scores[team]||{})[`Runde ${r}`] ?? 0);
          perRound.push(v); sum += v;
        }
        arr.push({ team, sum, perRound });
      }
      // sort desc by sum, then name asc
      arr.sort((a,b)=> (b.sum - a.sum) || a.team.localeCompare(b.team,'de'));

      rows = arr;
      idx = rows.length - 1; // <- START AM LETZTEN PLATZ (Bugfix)
      status(`${rows.length} Teams geladen. Bereit.`);
      startBtn.disabled = rows.length === 0;
      hint.textContent = rows.length ? 'Bereit. Klicke „Reveal starten“.' : 'Keine Teams gefunden.';
    }

    // ===== Reveal flow =====
    function startReveal(){
      if(!rows.length) return;
      tableWrap.style.display = 'none';
      box.style.display = '';
      hint.style.display = 'none';
      startBtn.disabled = true;
      nextBtn.disabled = false;
      showAllBtn.disabled = true;
      renderCurrent();
    }

    function renderCurrent(){
      const r = rows[idx];
      if(!r) return;
      const place = idx + 1; // da rows 0-basiert und nach Summe sortiert (desc)
      posEl.textContent = `Platz ${place}`;
      teamEl.textContent = r.team;
      ptsEl.textContent = `Gesamtpunkte: ${r.sum}`;
      // Scroll nach oben, damit die Box immer präsent ist
      window.scrollTo({ top: 0, behavior: 'auto' });
    }

    function nextReveal(){
      if(idx === null) return;
      idx--; // von unten nach oben
      if(idx >= 0){
        renderCurrent();
        // Wenn wir JETZT den 1. Platz anzeigen (idx === 0), -> Feuerwerk an
        if(idx === 0) startFireworks();
      }else{
        // fertig mit reveal
        nextBtn.disabled = true;
        showAllBtn.disabled = false;
        stopFireworks(); // falls noch läuft
      }
    }

    function showAll(){
      box.style.display = 'none';
      buildFullTable();
      tableWrap.style.display = '';
      showAllBtn.disabled = true;
    }

    // ===== Full table =====
    function buildFullTable(){
      thead.innerHTML = '';
      tbody.innerHTML = '';

      const tr = document.createElement('tr');
      tr.innerHTML = `
        <th style="width:64px;text-align:right">#</th>
        <th>Team</th>
        <th class="right">Gesamt</th>
      `;
      for(let r=1;r<=maxRounds;r++){
        const th = document.createElement('th'); th.className='right'; th.textContent = `R${r}`; tr.appendChild(th);
      }
      thead.appendChild(tr);

      let place = 1;
      for(const row of rows){
        const trb = document.createElement('tr');
        trb.innerHTML = `
          <td class="right">${place++}</td>
          <td>${esc(row.team)}</td>
          <td class="right total">${row.sum}</td>
        `;
        for(const v of row.perRound){
          const td = document.createElement('td'); td.className='right'; td.textContent = v; trb.appendChild(td);
        }
        tbody.appendChild(trb);
      }
    }

    // ===== Fireworks (simple canvas) =====
    let fxCtx, fxId = null, particles = [];

    function resizeFx(){
      fx.width = window.innerWidth;
      fx.height = Math.max(window.innerHeight, document.body.scrollHeight);
      fxCtx = fx.getContext('2d');
    }
    window.addEventListener('resize', ()=>{ if(fx.style.display!=='none'){ resizeFx(); } });

    function startFireworks(){
      fx.style.display = 'block';
      resizeFx();
      spawnBurst(); // sofort ein paar
      if(fxId) cancelAnimationFrame(fxId);
      fxLoop();
    }
    function stopFireworks(){
      fx.style.display = 'none';
      if(fxId) cancelAnimationFrame(fxId);
      fxId = null;
      particles = [];
    }

    function spawnBurst(){
      const w = fx.width, h = fx.height;
      const x = w*0.5, y = h*0.25; // zentral oben
      const count = 120;
      for(let i=0;i<count;i++){
        const angle = (Math.PI*2) * (i/count);
        const speed = 2 + Math.random()*3.5;
        particles.push({
          x, y,
          vx: Math.cos(angle)*speed,
          vy: Math.sin(angle)*speed - 1.2, // leicht nach oben
          life: 60 + Math.random()*40,
          age: 0
        });
      }
      // nochmal kleine Offsets
      setTimeout(()=>{ if(fx.style.display!=='none') spawnRandomBurst(); }, 700);
      setTimeout(()=>{ if(fx.style.display!=='none') spawnRandomBurst(); }, 1400);
    }
    function spawnRandomBurst(){
      const w = fx.width, h = fx.height;
      const x = (0.2 + Math.random()*0.6)*w;
      const y = (0.15 + Math.random()*0.35)*h;
      const count = 90;
      for(let i=0;i<count;i++){
        const angle = (Math.PI*2) * Math.random();
        const speed = 2 + Math.random()*4;
        particles.push({
          x, y,
          vx: Math.cos(angle)*speed,
          vy: Math.sin(angle)*speed - .8,
          life: 50 + Math.random()*40,
          age: 0
        });
      }
    }

    function fxLoop(){
      fxId = requestAnimationFrame(fxLoop);
      if(!fxCtx) return;
      fxCtx.clearRect(0,0,fx.width,fx.height);
      fxCtx.globalCompositeOperation = 'lighter';

      for(let i=particles.length-1;i>=0;i--){
        const p = particles[i];
        p.age++;
        p.x += p.vx;
        p.y += p.vy;
        p.vy += 0.03; // gravity
        const alpha = Math.max(0, 1 - p.age/p.life);
        if(alpha <= 0){
          particles.splice(i,1); continue;
        }
        fxCtx.globalAlpha = alpha;
        fxCtx.beginPath();
        fxCtx.arc(p.x, p.y, 2, 0, Math.PI*2);
        fxCtx.fillStyle = '#'+((Math.random()*0xFFFFFF)|0).toString(16).padStart(6,'0');
        fxCtx.fill();
      }

      // Wenn kaum noch Partikel da sind, wieder neuen Burst starten
      if(particles.length < 60){
        spawnRandomBurst();
      }
    }

    // ===== Events =====
    loadBtn.addEventListener('click', loadData);
    startBtn.addEventListener('click', startReveal);
    nextBtn.addEventListener('click', nextReveal);
    showAllBtn.addEventListener('click', showAll);
    maxRoundsSel.addEventListener('change', ()=>{
      // Wenn Runden geändert wurden, bitte neu laden
      status('Runden geändert – bitte „Daten laden“.');
      startBtn.disabled = true; nextBtn.disabled = true; showAllBtn.disabled = true;
    });

    // Init: versuche, aktuelle Runde zu lesen → Max Runden passend setzen
    (async function init(){
      try{
        const cr = await fetch('/current-round').then(r=>r.json());
        const r = parseInt(cr.round||6,10);
        if (r>6) maxRoundsSel.value = String(Math.min(10, Math.max(6, r)));
      }catch{}
      status('Bereit. Wähle „Max. Runden“ und klicke „Daten laden“.');
    })();
  </script>
</body>
</html>