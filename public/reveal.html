<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8" />
  <title>Reveal & Zwischenstand</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="stylesheet" href="style.css" />
  <style>
    :root{
      --fg:#0f172a; --muted:#64748b; --accent:#2563eb;
      --gold:#f59e0b; --silver:#9ca3af; --bronze:#b45309;
      --border:#e5e7eb; --card:#fff; --bg:#f6f8fb;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0; font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
      color:var(--fg); background:linear-gradient(180deg,#fff,var(--bg));
      min-height:100dvh;
    }
    .wrap{ width:min(1200px,96vw); margin:22px auto 40px; }
    h1{ margin:0 0 6px; }
    .sub{ color:var(--muted); margin:0 0 14px; }

    .toolbar{
      position:sticky; top:0; z-index:5;
      display:flex; flex-wrap:wrap; gap:10px; align-items:center;
      background:var(--card); border:1px solid var(--border); border-radius:14px; padding:12px;
      box-shadow:0 8px 20px rgba(2,6,23,.08);
    }
    .toolbar .sp{ flex:1 1 auto }
    button, .btn{
      padding:10px 14px; border:1px solid var(--border); border-radius:10px; background:#fff; cursor:pointer; font-weight:700;
    }
    button.primary{ background:linear-gradient(135deg,#22c55e,#16a34a); color:#fff; border:none; }
    button.warn{ background:linear-gradient(135deg,#f59e0b,#d97706); color:#fff; border:none; }
    label{ font-weight:600; }
    input[type="checkbox"]{ transform: translateY(1px); }

    .card{
      background:var(--card); border:1px solid var(--border); border-radius:16px; padding:16px;
      box-shadow:0 8px 24px rgba(2,6,23,.08); margin-top:16px; overflow:auto;
    }
    table{ width:100%; border-collapse:collapse; font-size:16px; }
    thead th{ position:sticky; top:0; background:#f8fafc; border-bottom:1px solid var(--border); padding:10px; text-align:left; }
    tbody td{ border-bottom:1px solid #eef2f7; padding:10px; vertical-align:top; }
    .right{text-align:right}

    .rank{ font-weight:900; width:60px; }
    .rank.gold{ color:var(--gold); }
    .rank.silver{ color:var(--silver); }
    .rank.bronze{ color:var(--bronze); }

    .pill{
      display:inline-block; padding:.2rem .5rem; border:1px solid var(--border); border-radius:999px;
      background:#fff; font-size:.9rem;
    }

    /* Canvas Feuerwerk */
    #fx{
      position:fixed; inset:0; pointer-events:none; z-index:20; display:none;
    }
  </style>
</head>
<body>
  <canvas id="fx"></canvas>

  <div class="wrap">
    <h1>Reveal & Zwischenstand</h1>
    <p class="sub">Volle Rangliste, optional mit Punkten pro Runde. Aktualisiert sich auf Wunsch automatisch.</p>

    <div class="toolbar">
      <button class="primary" id="btnReload">Neu laden</button>

      <label style="margin-left:6px;">
        <input type="checkbox" id="cbAuto" />
        Auto-Refresh (5s)
      </label>

      <label style="margin-left:6px;">
        <input type="checkbox" id="cbRounds" checked />
        Punkte je Runde zeigen
      </label>

      <button id="btnSortTotal">Nach Gesamt sortieren</button>
      <button id="btnSortName">Nach Name sortieren</button>

      <div class="sp"></div>

      <button class="warn" id="btnFireworks">Feuerwerk</button>
      <button id="btnFull">Vollbild</button>
    </div>

    <div class="card">
      <table id="tbl">
        <thead id="thead"></thead>
        <tbody id="tbody"></tbody>
      </table>
    </div>
  </div>

  <script>
    const MAX_ROUNDS = 10;

    const thead = document.getElementById('thead');
    const tbody = document.getElementById('tbody');
    const cbAuto = document.getElementById('cbAuto');
    const cbRounds = document.getElementById('cbRounds');
    const btnReload = document.getElementById('btnReload');
    const btnSortTotal = document.getElementById('btnSortTotal');
    const btnSortName = document.getElementById('btnSortName');
    const btnFull = document.getElementById('btnFull');
    const btnFireworks = document.getElementById('btnFireworks');

    let allScores = {};
    let allTeams = [];
    let sortMode = 'total'; // 'total' | 'name'
    let timer = null;

    function sumTeam(team){
      let s = 0;
      for(let r=1;r<=MAX_ROUNDS;r++){
        s += Number(allScores?.[team]?.[`Runde ${r}`] || 0);
      }
      return s;
    }

    function buildHead(){
      thead.innerHTML = '';
      const tr = document.createElement('tr');
      const thRank = document.createElement('th'); thRank.textContent = '#'; tr.appendChild(thRank);
      const thTeam = document.createElement('th'); thTeam.textContent = 'Team'; tr.appendChild(thTeam);
      const thTotal = document.createElement('th'); thTotal.textContent = 'Gesamt'; thTotal.className='right'; tr.appendChild(thTotal);
      if (cbRounds.checked){
        for(let r=1;r<=MAX_ROUNDS;r++){
          const th = document.createElement('th'); th.textContent = `R ${r}`; th.className='right';
          tr.appendChild(th);
        }
      }
      thead.appendChild(tr);
    }

    function render(){
      buildHead();
      // Basismenge Teams: bekannte Teams + Teams mit Scores
      const set = new Set([...allTeams, ...Object.keys(allScores||{})]);
      let rows = Array.from(set);

      if (sortMode === 'name'){
        rows.sort((a,b)=>a.localeCompare(b,'de'));
      } else {
        rows.sort((a,b)=> sumTeam(b) - sumTeam(a) || a.localeCompare(b,'de'));
      }

      // Plätze vergeben (mit Gleichständen)
      const totals = rows.map(t => ({team:t, total: sumTeam(t)}));
      const places = new Map();
      let prev = null, place = 0;
      totals.forEach((x, idx) => {
        if (prev === null || x.total < prev) place = idx + 1;
        places.set(x.team, place);
        prev = x.total;
      });

      tbody.innerHTML = '';
      for(const team of rows){
        const tr = document.createElement('tr');

        const rank = places.get(team);
        const tdRank = document.createElement('td');
        tdRank.className = 'rank ' + (rank===1?'gold':rank===2?'silver':rank===3?'bronze':'');
        tdRank.textContent = rank;
        tr.appendChild(tdRank);

        const tdTeam = document.createElement('td'); tdTeam.textContent = team; tr.appendChild(tdTeam);

        const total = sumTeam(team);
        const tdTotal = document.createElement('td'); tdTotal.className='right'; tdTotal.innerHTML = `<b>${total}</b>`;
        tr.appendChild(tdTotal);

        if (cbRounds.checked){
          for(let r=1;r<=MAX_ROUNDS;r++){
            const td = document.createElement('td'); td.className='right';
            const v = Number(allScores?.[team]?.[`Runde ${r}`] || 0);
            td.textContent = v ? v : '–';
            tr.appendChild(td);
          }
        }

        tbody.appendChild(tr);
      }
    }

    async function loadAll(){
      const [teams, scores] = await Promise.all([
        fetch('/teams').then(r=>r.json()).catch(()=>[]),
        fetch('/scores').then(r=>r.json()).catch(()=>({}))
      ]);
      allTeams = Array.isArray(teams) ? teams : [];
      allScores = (scores && typeof scores==='object') ? scores : {};
    }

    async function refresh(){
      clearTimeout(timer);
      await loadAll();
      render();
      if (cbAuto.checked){
        timer = setTimeout(refresh, 5000);
      }
    }

    // Fullscreen
    btnFull.addEventListener('click', ()=>{
      const el = document.documentElement;
      if (!document.fullscreenElement) el.requestFullscreen?.();
      else document.exitFullscreen?.();
    });

    // Sortierer
    btnSortTotal.addEventListener('click', ()=>{ sortMode='total'; render(); });
    btnSortName.addEventListener('click', ()=>{ sortMode='name'; render(); });

    cbRounds.addEventListener('change', render);
    cbAuto.addEventListener('change', refresh);
    btnReload.addEventListener('click', refresh);

    // ========= Feuerwerk =========
    const fx = document.getElementById('fx');
    const ctx = fx.getContext('2d');
    let fwTimer = null, particles = [];

    function resizeCanvas(){
      fx.width = window.innerWidth;
      fx.height = window.innerHeight;
    }
    window.addEventListener('resize', resizeCanvas);
    resizeCanvas();

    function rand(min,max){ return Math.random()*(max-min)+min; }

    function burst(x,y,colors,amount=80){
      for(let i=0;i<amount;i++){
        const angle = Math.random()*Math.PI*2;
        const speed = rand(2,6);
        particles.push({
          x,y,
          vx: Math.cos(angle)*speed,
          vy: Math.sin(angle)*speed,
          life: rand(60,120),
          color: colors[(Math.random()*colors.length)|0],
          size: rand(2,4),
          gravity: 0.05,
          drag: 0.99
        });
      }
    }

    function step(){
      ctx.clearRect(0,0,fx.width,fx.height);
      particles.forEach(p=>{
        p.vx *= p.drag;
        p.vy = p.vy*p.drag + p.gravity;
        p.x += p.vx; p.y += p.vy;
        p.life--;
        ctx.globalAlpha = Math.max(p.life/120, 0);
        ctx.fillStyle = p.color;
        ctx.beginPath(); ctx.arc(p.x,p.y,p.size,0,Math.PI*2); ctx.fill();
      });
      particles = particles.filter(p=>p.life>0 && p.y<fx.height+20);
      if (particles.length>0 || fwTimer){ requestAnimationFrame(step); }
    }

    function fireworkShow(durationMs=5000){
      fx.style.display='block';
      const colors = ['#fbbf24','#60a5fa','#f472b6','#34d399','#f87171','#a78bfa'];
      const spawn = ()=> {
        burst(rand(0.2*fx.width,0.8*fx.width), rand(0.2*fx.height,0.5*fx.height), colors, 100);
      };
      spawn();
      fwTimer = setInterval(spawn, 700);
      step();
      setTimeout(()=>{
        clearInterval(fwTimer); fwTimer=null;
        setTimeout(()=>{ fx.style.display='none'; }, 1600);
      }, durationMs);
    }

    btnFireworks.addEventListener('click', ()=> fireworkShow(6000));

    // Init
    refresh();
  </script>
</body>
</html>