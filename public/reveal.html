<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8" />
  <title>Reveal ‚Äì Platz f√ºr Platz</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="stylesheet" href="style.css" />
  <style>
    :root{
      --fg:#0f172a; --muted:#64748b;
      --border:#e5e7eb; --card:#fff; --bg:#f6f8fb; --shadow:0 8px 24px rgba(2,6,23,.12);
      --gold:#ffd700; --silver:#c0c0c0; --bronze:#cd7f32;
    }
    body{
      margin:0; font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
      color:var(--fg); background:linear-gradient(180deg,#fff,var(--bg));
      min-height:100dvh;
      display:flex; flex-direction:column; align-items:center; justify-content:flex-start;
    }
    h1{ margin:20px 0 6px; text-align:center; }
    p.sub{ color:var(--muted); margin:0 0 20px; text-align:center; }
    .card{
      background:var(--card); border:1px solid var(--border); border-radius:16px;
      padding:20px; box-shadow:var(--shadow); margin-top:16px; width:min(800px,95vw);
    }
    .entry{
      display:flex; justify-content:space-between; align-items:center;
      border-bottom:1px solid #eef2f7; padding:14px 10px; font-size:20px;
      opacity:0; transform:translateY(20px); transition:all .5s ease;
    }
    .entry.visible{ opacity:1; transform:translateY(0); }
    .rank{ font-weight:900; font-size:22px; width:70px; text-align:center; }
    .team{ flex:1; }
    .score{ font-weight:700; }
    .gold{ color:var(--gold); }
    .silver{ color:var(--silver); }
    .bronze{ color:var(--bronze); }

    /* Dock */
    .dock{
      position:fixed; right:14px; top:14px; z-index:40;
      background:#ffffffee; backdrop-filter: blur(6px);
      border:1px solid var(--border); border-radius:12px; box-shadow:var(--shadow);
      padding:8px; display:flex; flex-direction:column; gap:6px;
    }
    .dock button{
      padding:10px 14px; border:1px solid var(--border); border-radius:8px; background:#fff;
      cursor:pointer; font-weight:800; font-size:14px;
    }
    .dock button.primary{
      background:linear-gradient(135deg,#22c55e,#16a34a); border:none; color:#fff;
    }
    .dock button.warn{
      background:linear-gradient(135deg,#f59e0b,#d97706); border:none; color:#fff;
    }

    /* Feuerwerk */
    #fx{ position:fixed; inset:0; pointer-events:none; z-index:30; display:none; }
  </style>
</head>
<body>
  <canvas id="fx"></canvas>

  <div class="dock">
    <button class="primary" id="btnNext">N√§chster Platz zeigen</button>
    <button id="btnFull">Vollbild</button>
    <button class="warn" id="btnFireworks">Feuerwerk</button>
  </div>

  <h1>Platzierungen</h1>
  <p class="sub">Ein Team nach dem anderen ‚Äì von hinten bis zum Sieger üèÜ</p>

  <div class="card" id="list"></div>

  <script>
    const listEl = document.getElementById("list");
    const btnNext = document.getElementById("btnNext");
    const btnFull = document.getElementById("btnFull");
    const btnFireworks = document.getElementById("btnFireworks");

    let allScores = {}, allTeams = [];
    let revealOrder = [], currentIndex = 0;

    function sumTeam(team){
      let total = 0;
      for(let r=1;r<=10;r++){
        total += Number(allScores?.[team]?.[`Runde ${r}`]||0);
      }
      return total;
    }

    async function loadData(){
      const [teams, scores] = await Promise.all([
        fetch("/teams").then(r=>r.json()).catch(()=>[]),
        fetch("/scores").then(r=>r.json()).catch(()=>({}))
      ]);
      allTeams = Array.isArray(teams)?teams:[];
      allScores = scores||{};
      prepareOrder();
    }

    function prepareOrder(){
      const set = new Set([...allTeams, ...Object.keys(allScores||{})]);
      let rows = Array.from(set);
      rows.sort((a,b)=> sumTeam(b)-sumTeam(a) || a.localeCompare(b,'de'));
      revealOrder = rows; // Platz 1 = [0], letzter = [n-1]
      currentIndex = revealOrder.length-1; // Start: letzter Platz
      listEl.innerHTML = "";
    }

    function showNext(){
      if(currentIndex < 0) return;
      const team = revealOrder[currentIndex];
      const total = sumTeam(team);
      const place = currentIndex+1; // weil 0-basiert
      const div = document.createElement("div");
      div.className = "entry";
      let rankClass = "";
      if(place===1) rankClass="gold";
      else if(place===2) rankClass="silver";
      else if(place===3) rankClass="bronze";
      div.innerHTML = `<div class="rank ${rankClass}">${place}${place===1?" ü•á":place===2?" ü•à":place===3?" ü•â":""}</div>
                       <div class="team">${team}</div>
                       <div class="score">${total}</div>`;
      listEl.prepend(div);
      requestAnimationFrame(()=> div.classList.add("visible"));

      if(place===1){
        fireworks(6000);
        btnNext.disabled = true;
      }
      currentIndex--;
    }

    btnNext.addEventListener("click", showNext);
    btnFull.addEventListener("click", ()=>{
      const el=document.documentElement;
      if(!document.fullscreenElement) el.requestFullscreen?.(); else document.exitFullscreen?.();
    });

    // ==== Feuerwerk ====
    const fx=document.getElementById('fx'), ctx=fx.getContext('2d');
    function size(){ fx.width=innerWidth; fx.height=innerHeight; }
    addEventListener('resize',size); size();
    let fwTimer=null, parts=[];
    function rnd(a,b){return Math.random()*(b-a)+a}
    function burst(){
      const x=rnd(0.2*fx.width,0.8*fx.width), y=rnd(0.2*fx.height,0.5*fx.height);
      const colors=['#fbbf24','#60a5fa','#f472b6','#34d399','#f87171','#a78bfa'];
      for(let i=0;i<100;i++){
        const ang=Math.random()*Math.PI*2, sp=rnd(2,6);
        parts.push({x,y,vx:Math.cos(ang)*sp,vy:Math.sin(ang)*sp,l:rnd(60,120),c:colors[(Math.random()*colors.length)|0],g:0.05,d:0.99,s:rnd(2,4)});
      }
    }
    function step(){
      ctx.clearRect(0,0,fx.width,fx.height);
      parts.forEach(p=>{
        p.vx*=p.d; p.vy=p.vy*p.d+p.g; p.x+=p.vx; p.y+=p.vy; p.l--;
        ctx.globalAlpha=Math.max(p.l/120,0);
        ctx.fillStyle=p.c;
        ctx.beginPath(); ctx.arc(p.x,p.y,p.s,0,Math.PI*2); ctx.fill();
      });
      parts=parts.filter(p=>p.l>0);
      if(parts.length>0||fwTimer) requestAnimationFrame(step);
    }
    function fireworks(ms=6000){
      fx.style.display='block';
      burst(); fwTimer=setInterval(burst,700);
      step();
      setTimeout(()=>{ clearInterval(fwTimer); fwTimer=null; setTimeout(()=>fx.style.display='none',1500); },ms);
    }
    btnFireworks.addEventListener('click', ()=>fireworks(6000));

    loadData();
  </script>
</body>
</html>