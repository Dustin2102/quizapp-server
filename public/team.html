<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8" />
  <title>Teamansicht – Antworten</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="stylesheet" href="style.css" />
  <style>
    :root{
      /* === Farben zentral, hier anpassbar === */
      --fg:#0f172a;            /* Text */
      --muted:#64748b;         /* Sekundärtext */
      --accent:#3b82f6;        /* Markenfarbe (Blau) */
      --accent-2:#22c55e;      /* Grün */
      --accent-3:#ef4444;      /* Rot */
      --bg-from:#ffffff;
      --bg-to:#f6f8fb;
      --card:#ffffff;
      --ring: rgba(59,130,246,.18);
      --shadow: 0 6px 20px rgba(2,6,23,.08);
      --border:#e5e7eb;
      --btn-grad-from:#22c55e; /* Submit-Button Verlauf */
      --btn-grad-to:#16a34a;
      --btn-grad-hover:#0f9a40;
    }

    /* Grundlayout */
    html,body{height:100%}
    body{
      margin:0; padding:0;
      font-family:system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      color:var(--fg);
      background: linear-gradient(180deg, var(--bg-from), var(--bg-to));
      min-height:100dvh; display:flex; align-items:flex-start; justify-content:center;
    }
    .wrap{ width:min(980px, 92vw); margin:56px auto 40px; text-align:center; }

    /* Header / Logo */
    header img{ max-height:72px; margin-bottom:12px; filter: drop-shadow(0 2px 6px rgba(0,0,0,.08)); }

    /* Titel & Badge */
    h1{
      font-size:clamp(1.6rem, 1.2rem + 2vw, 2.6rem);
      margin:.2rem 0 .6rem;
      letter-spacing:.2px;
    }
    .sub{ color:var(--muted); margin:.2rem 0 1.2rem; font-size:1.05rem; }
    .badge{
      display:inline-flex; align-items:center; gap:.5rem;
      padding:.35rem .7rem; border-radius:999px; font-weight:600; font-size:.95rem;
      border:1px solid var(--border); background:#f8fafc; color:#0f172a;
    }
    .dot{width:.55rem;height:.55rem;border-radius:50%;}
    .open  .dot{ background:var(--accent-2); }
    .closed .dot{ background:var(--accent-3); }
    .open{ border-color:#bbf7d0; background:#f0fdf4; color:#14532d; }
    .closed{ border-color:#fecaca; background:#fef2f2; color:#7f1d1d; }

    /* Karten / Blöcke */
    .card{
      background:var(--card); border:1px solid var(--border); border-radius:16px;
      padding:26px; box-shadow:var(--shadow);
    }

    /* Wartesection */
    .wait{ margin-top:10px; }
    .wait h2{ font-size:clamp(1.3rem,1rem + 1.5vw,2rem); margin:.2rem 0 .5rem; }
    .spin{
      width:48px; height:48px; border-radius:999px; margin:10px auto 8px;
      border:4px solid #e5e7eb; border-top-color:var(--accent);
      animation:spin 1s linear infinite;
    }
    @keyframes spin { to { transform: rotate(360deg); } }

    /* Formular / Grid */
    form { margin-top:14px; }
    .grid{
      display:grid; gap:12px; justify-content:center;
      grid-template-columns: repeat(6, minmax(64px, 1fr));
    }
    @media (max-width: 920px){ .grid{ grid-template-columns: repeat(4, minmax(70px, 1fr)); } }
    @media (max-width: 560px){ .grid{ grid-template-columns: repeat(3, minmax(78px, 1fr)); } }

    .cell{
      background:#fff; border:1px solid var(--border); border-radius:12px; padding:8px 10px;
      display:flex; flex-direction:column; align-items:center; gap:6px;
      box-shadow:0 3px 10px rgba(2,6,23,.05);
    }
    .cell label{ font-size:.9rem; color:#334155; font-weight:600; }
    .cell input{
      width:100%; padding:10px 8px; text-align:center; font-size:1.06rem;
      border:1px solid #d1d5db; border-radius:10px; outline:none; transition: box-shadow .15s, border-color .15s;
      background:#fdfdfd;
    }
    .cell input:focus{ border-color:var(--accent); box-shadow:0 0 0 4px var(--ring); background:#fff; }

    /* Submit */
    button[type="submit"]{
      padding:14px 26px; font-size:1.05rem; margin-top:18px; font-weight:700;
      background:linear-gradient(135deg, var(--btn-grad-from), var(--btn-grad-to));
      color:#fff; border:none; border-radius:14px; cursor:pointer; box-shadow:0 10px 24px rgba(34,197,94,.25);
    }
    button[type="submit"]:hover{ filter:saturate(1.05); background:var(--btn-grad-hover); }

    /* Status */
    .status{ margin-top:14px; font-weight:700; }
    .abgegeben{ color:var(--accent-2); }
    .gesperrt{ color:var(--accent-3); }
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <img src="/logo.png" alt="Quiz-Logo" onerror="this.style.display='none'">
    </header>

    <h1>Antwort-Eingabe</h1>
    <p class="sub">
      <span id="rundeBadge" class="badge closed">
        <span class="dot"></span>
        <span id="rundeInfoText">Runde – lädt…</span>
      </span>
    </p>

    <!-- Wartesection -->
    <section id="waitSection" class="card wait" style="display:none">
      <div class="spin"></div>
      <h2 id="waitHeadline">Bitte warten, das Quiz startet gleich…</h2>
      <p class="sub" id="waitSub">Diese Runde ist noch geschlossen. Der Bildschirm aktualisiert sich automatisch.</p>
    </section>

    <!-- Formular -->
    <form id="antwortForm" onsubmit="submitAnswers(event)" style="display:none">
      <div id="eingaben" class="grid"></div>
      <button type="submit">Antworten abgeben</button>
    </form>

    <p id="status" class="status"></p>
  </div>

  <script>
    const teamName = localStorage.getItem("teamName");
    if (!teamName) { window.location.href = "start.html"; }

    let inputsBuilt = false;

    document.addEventListener("DOMContentLoaded", () => {
      refreshState();
      setInterval(refreshState, 4000); // Auto-Refresh
    });

    async function refreshState(){
      try{
        const res = await fetch("/current-round");
        const data = await res.json();
        const aktuelleRunde = parseInt(data.round);
        const closed = !!data.closed;

        // Runde 7 -> Schlussbildschirm
        if (aktuelleRunde >= 7) { window.location.href = "finished.html"; return; }

        updateBadge(aktuelleRunde, closed);

        if (aktuelleRunde < 1 || closed) {
          showWait(true, aktuelleRunde);
          hideForm();
          return;
        }

        showWait(false);
        buildInputsOnce();
        await checkAlreadySubmitted(aktuelleRunde);
      }catch(e){
        console.error(e);
        setBadgeText("Rundenstatus: Fehler");
      }
    }

    function updateBadge(runde, closed){
      const badge = document.getElementById("rundeBadge");
      badge.classList.remove("open","closed");
      badge.classList.add(closed ? "closed" : "open");
      setBadgeText(`Runde ${runde} – ${closed ? "geschlossen" : "offen"}`);
    }
    function setBadgeText(text){
      document.getElementById("rundeInfoText").textContent = text;
    }

    function showWait(visible, runde){
      const sec = document.getElementById("waitSection");
      sec.style.display = visible ? "block" : "none";
      if (!visible) return;
      document.getElementById("waitHeadline").textContent =
        (runde < 1) ? "Bitte warten, das Quiz startet gleich…" : "Runde ist noch geschlossen…";
      document.getElementById("waitSub").textContent =
        "Sobald die Moderation startet, öffnet sich die Eingabe automatisch.";
    }
    function hideForm(){ document.getElementById("antwortForm").style.display = "none"; }
    function showForm(){ document.getElementById("antwortForm").style.display = "block"; }

    function buildInputsOnce(){
      if (inputsBuilt) { showForm(); return; }
      const eingabenDiv = document.getElementById("eingaben");
      eingabenDiv.innerHTML = "";
      for (let i = 0; i < 12; i++) {
        const cell = document.createElement("div");
        cell.className = "cell";
        cell.innerHTML = `
          <label for="a${i+1}">${i+1}.</label>
          <input id="a${i+1}" name="a${i+1}" autocomplete="off" required />
        `;
        eingabenDiv.appendChild(cell);
      }
      inputsBuilt = true;
      showForm();
    }

    async function checkAlreadySubmitted(aktuelleRunde){
      try{
        const antwRes = await fetch("/data/teamAnswers.json");
        const antwData = await antwRes.json();
        const vorhanden = antwData[`round_${aktuelleRunde}`]?.[teamName];
        const statusEl = document.getElementById("status");
        const form = document.getElementById("antwortForm");

        if (vorhanden) {
          statusEl.textContent = "Du hast diese Runde bereits abgegeben.";
          statusEl.className = "status abgegeben";
          form.style.display = "none";
        } else {
          statusEl.textContent = "";
          statusEl.className = "status";
          form.style.display = "block";
        }
      }catch(e){ console.error(e); }
    }

    async function submitAnswers(e){
      e.preventDefault();
      const form = document.getElementById("antwortForm");
      const formData = new FormData(form);
      const answers = [];
      for (let i = 1; i <= 12; i++) answers.push(formData.get(`a${i}`) || "");

      // State frisch holen (Rennbedingungen vermeiden)
      const res = await fetch("/current-round");
      const data = await res.json();
      const aktuelleRunde = parseInt(data.round);

      const payload = { teamName, round: aktuelleRunde, answers };

      try{
        const response = await fetch("/submit-answers", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(payload),
        });

        const statusEl = document.getElementById("status");

        if (response.status === 200) {
          statusEl.textContent = "Antworten erfolgreich abgegeben!";
          statusEl.className = "status abgegeben";
          form.style.display = "none";
        } else if (response.status === 409) {
          statusEl.textContent = "Du hast bereits abgegeben.";
          statusEl.className = "status abgegeben";
          form.style.display = "none";
        } else if (response.status === 423) {
          statusEl.textContent = "Runde beendet – nächste Runde in ein paar Minuten.";
          statusEl.className = "status gesperrt";
          form.style.display = "none";
          showWait(true, aktuelleRunde);
        } else {
          statusEl.textContent = "Fehler beim Absenden!";
          statusEl.className = "status";
        }
      }catch(err){
        document.getElementById("status").textContent = "Serverfehler";
      }
    }
  </script>
</body>
</html>