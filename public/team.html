<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8" />
  <title>Teamansicht – Antworten</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="stylesheet" href="style.css" />
  <style>
    :root{
      --fg:#0f172a; --muted:#64748b; --accent:#3b82f6;
      --accent-2:#22c55e; --accent-3:#ef4444;
      --bg-from:#ffffff; --bg-to:#f6f8fb; --card:#ffffff;
      --ring: rgba(59,130,246,.18); --border:#e5e7eb;
      --btn-grad-from:#22c55e; --btn-grad-to:#16a34a; --btn-grad-hover:#0f9a40;
      --shadow: 0 6px 20px rgba(2,6,23,.08);
    }

    html,body{height:100%}
    body{
      margin:0; padding:0; font-family:system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      color:var(--fg);
      background: linear-gradient(180deg, var(--bg-from), var(--bg-to));
      min-height:100dvh; display:flex; align-items:flex-start; justify-content:center;
    }
    .wrap{ width:min(560px, 94vw); margin:56px auto 40px; text-align:center; }

    header img{ max-height:64px; margin-bottom:10px; filter: drop-shadow(0 2px 6px rgba(0,0,0,.08)); }
    h1{ font-size:clamp(1.6rem, 1.2rem + 2vw, 2.4rem); margin:.2rem 0 .4rem; }
    .sub{ color:var(--muted); margin:.2rem 0 1rem; font-size:1.02rem; }

    .badge{
      display:inline-flex; align-items:center; gap:.5rem;
      padding:.35rem .7rem; border-radius:999px; font-weight:600; font-size:.95rem;
      border:1px solid var(--border); background:#f8fafc; color:#0f172a;
    }
    .dot{width:.55rem;height:.55rem;border-radius:50%;}
    .open  .dot{ background:var(--accent-2); }
    .closed .dot{ background:var(--accent-3); }
    .open{ border-color:#bbf7d0; background:#f0fdf4; color:#14532d; }
    .closed{ border-color:#fecaca; background:#fef2f2; color:#7f1d1d; }

    .team-badge{
      display:inline-block; margin:.35rem 0 .8rem; font-weight:700;
      padding:.35rem .7rem; border-radius:10px; border:1px solid var(--border); background:#fff;
    }

    .card{
      background:var(--card); border:1px solid var(--border); border-radius:16px;
      padding:20px; box-shadow:var(--shadow);
    }

    /* Wartesection */
    .wait{ margin-top:10px; }
    .wait h2{ font-size:clamp(1.2rem,1rem + 1.2vw,1.8rem); margin:.2rem 0 .5rem; }
    .spin{
      width:44px; height:44px; border-radius:999px; margin:10px auto 8px;
      border:4px solid #e5e7eb; border-top-color:var(--accent);
      animation:spin 1s linear infinite;
    }
    @keyframes spin { to { transform: rotate(360deg); } }

    /* Liste (untereinander) */
    form{ margin-top:8px; }
    .list{ display:flex; flex-direction:column; gap:10px; }
    .row{
      text-align:left; background:#fff; border:1px solid var(--border); border-radius:12px;
      padding:10px 12px; box-shadow:0 3px 10px rgba(2,6,23,.05);
    }
    .row label{ display:block; font-size:.95rem; color:#334155; font-weight:600; margin-bottom:6px; }
    .row input{
      width:100%; padding:12px 10px; font-size:1.06rem; border:1px solid #d1d5db; border-radius:10px;
      outline:none; transition: box-shadow .15s, border-color .15s; background:#fdfdfd;
    }
    .row input:focus{ border-color:var(--accent); box-shadow:0 0 0 4px var(--ring); background:#fff; }

    button[type="submit"]{
      width:100%; padding:14px 22px; font-size:1.05rem; margin-top:14px; font-weight:700;
      background:linear-gradient(135deg, var(--btn-grad-from), var(--btn-grad-to));
      color:#fff; border:none; border-radius:14px; cursor:pointer; box-shadow:0 10px 24px rgba(34,197,94,.25);
    }
    button[type="submit"]:hover{ filter:saturate(1.05); background:var(--btn-grad-hover); }

    .status{ margin-top:12px; font-weight:700; }
    .abgegeben{ color:var(--accent-2); }
    .gesperrt{ color:var(--accent-3); }
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <img src="/logo.png" alt="Quiz-Logo" onerror="this.style.display='none'">
    </header>

    <h1>Antwort-Eingabe</h1>
    <div class="team-badge" id="teamBadge">Team: –</div>
    <p class="sub">
      <span id="rundeBadge" class="badge closed">
        <span class="dot"></span>
        <span id="rundeInfoText">Runde – lädt…</span>
      </span>
    </p>

    <!-- Wartesection -->
    <section id="waitSection" class="card wait" style="display:none">
      <div class="spin"></div>
      <h2 id="waitHeadline">Bitte warten, das Quiz startet gleich…</h2>
      <p class="sub" id="waitSub">Diese Runde ist noch geschlossen. Der Bildschirm aktualisiert sich automatisch.</p>
    </section>

    <!-- Formular -->
    <form id="antwortForm" onsubmit="submitAnswers(event)" style="display:none">
      <div id="eingaben" class="list"></div>
      <button type="submit">Antworten abgeben</button>
    </form>

    <p id="status" class="status"></p>
  </div>

  <script>
    // ===== Einstellungen =====
    const MAX_ROUNDS = 10;                // bis zu 10 Runden
    const END_ROUND_VALUE = MAX_ROUNDS+1; // „X“ (Ende) -> finished.html

    // ===== Rejoin-Logik: Token + Heartbeat =====
    const LS_TEAM = "teamName";
    const LS_TOKEN = "teamToken";

    async function ensureTokenForTeam(name) {
      try {
        const r = await fetch("/teams/get-or-assign-token", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ teamName: name }),
        });
        if (!r.ok) return null;
        const { token } = await r.json();
        if (token) localStorage.setItem(LS_TOKEN, token);
        return token || null;
      } catch { return null; }
    }

    async function tryRejoinByToken() {
      const token = localStorage.getItem(LS_TOKEN);
      if (!token) return null;
      try {
        const r = await fetch(`/teams/rejoin?token=${encodeURIComponent(token)}`);
        if (!r.ok) return null;
        const { teamName } = await r.json();
        if (teamName) {
          localStorage.setItem(LS_TEAM, teamName);
          return teamName;
        }
        return null;
      } catch { return null; }
    }

    async function heartbeatOnce() {
      const token = localStorage.getItem(LS_TOKEN);
      if (!token) return;
      const hidden = document.visibilityState === "hidden";
      try {
        await fetch("/teams/heartbeat", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ token, pageHidden: hidden }),
        });
      } catch {}
    }
    document.addEventListener("visibilitychange", heartbeatOnce);

    // ===== App-Identity =====
    let teamName = localStorage.getItem(LS_TEAM);

    (async function initIdentity(){
      if (!teamName) {
        const rejoined = await tryRejoinByToken();
        if (rejoined) {
          teamName = rejoined;
        } else {
          window.location.href = "start.html";
          return;
        }
      }
      if (!localStorage.getItem(LS_TOKEN)) {
        await ensureTokenForTeam(teamName);
      }
      document.getElementById("teamBadge").textContent = "Team: " + teamName;

      // Heartbeat starten (alle 5s + bei Sichtbarkeitswechsel)
      heartbeatOnce();
      setInterval(heartbeatOnce, 5000);

      // App starten
      bootApp();
    })();

    // ===== Bestehende App-Logik =====
    let inputsBuilt = false;
    let lastRound = -1;
    let lastClosed = null;

    function bootApp(){
      refreshState();
      setInterval(refreshState, 4000); // Auto-Refresh
    }

    async function refreshState(){
      try{
        const res = await fetch("/current-round");
        const data = await res.json();
        const aktuelleRunde = parseInt(data.round, 10);
        const closed = !!data.closed;

        const roundChanged = (lastRound !== aktuelleRunde);
        const reopened = (lastClosed === true && closed === false && lastRound === aktuelleRunde);

        if (roundChanged || reopened) {
          clearAllInputs();
          resetStatus();
        }
        lastRound = aktuelleRunde;
        lastClosed = closed;

        // Ende (X): alles > MAX_ROUNDS
        if (aktuelleRunde > MAX_ROUNDS) { window.location.href = "finished.html"; return; }

        updateBadge(aktuelleRunde, closed);

        // Start (0) oder geschlossen/noch nicht gestartet
        if (aktuelleRunde === 0 || aktuelleRunde < 1 || closed) {
          showWait(true, aktuelleRunde, closed);
          hideForm();
          return;
        }

        // Eingabe möglich (1..MAX_ROUNDS, offen)
        showWait(false);
        buildInputsOnce();
        await checkAlreadySubmitted(aktuelleRunde);
      }catch(e){
        console.error(e);
        setBadgeText("Rundenstatus: Fehler");
      }
    }

    function updateBadge(runde, closed){
      const badge = document.getElementById("rundeBadge");
      badge.classList.remove("open","closed");
      badge.classList.add(closed ? "closed" : "open");
      if (runde === 0) {
        setBadgeText(`Start – ${closed ? "geschlossen" : "offen"}`);
      } else {
        setBadgeText(`Runde ${runde} – ${closed ? "geschlossen" : "offen"}`);
      }
    }
    function setBadgeText(text){ document.getElementById("rundeInfoText").textContent = text; }

    function showWait(visible, runde, closed){
      const sec = document.getElementById("waitSection");
      sec.style.display = visible ? "block" : "none";
      if (!visible) return;

      if (runde === 0) {
        document.getElementById("waitHeadline").textContent = "Willkommen zum Quiz!";
        document.getElementById("waitSub").textContent = "Bitte warte, bis die Moderation das Quiz startet. Der Bildschirm aktualisiert sich automatisch.";
      } else if (runde < 1 || closed) {
        document.getElementById("waitHeadline").textContent = "Runde ist noch geschlossen…";
        document.getElementById("waitSub").textContent = "Sobald die Moderation öffnet, erscheint die Eingabe automatisch.";
      } else {
        document.getElementById("waitHeadline").textContent = "Bitte warten…";
        document.getElementById("waitSub").textContent = "Gleich geht es weiter.";
      }
    }
    function hideForm(){ document.getElementById("antwortForm").style.display = "none"; }
    function showForm(){ document.getElementById("antwortForm").style.display = "block"; }

    function buildInputsOnce(){
      if (inputsBuilt) { showForm(); return; }
      const eingabenDiv = document.getElementById("eingaben");
      eingabenDiv.innerHTML = "";
      for (let i = 0; i < 12; i++) {
        const row = document.createElement("div");
        row.className = "row";
        row.innerHTML = `
          <label for="a${i+1}">Frage ${i+1}</label>
          <input id="a${i+1}" name="a${i+1}" autocomplete="off" required />
        `;
        eingabenDiv.appendChild(row);
      }
      inputsBuilt = true;
      showForm();
    }

    function clearAllInputs(){
      for (let i = 1; i <= 12; i++) {
        const el = document.getElementById("a"+i);
        if (el) el.value = "";
      }
    }

    function resetStatus(){
      const s = document.getElementById("status");
      s.textContent = "";
      s.className = "status";
    }

    async function checkAlreadySubmitted(aktuelleRunde){
      try{
        const antwRes = await fetch("/data/teamAnswers.json");
        const antwData = await antwRes.json();
        const vorhanden = antwData[`round_${aktuelleRunde}`]?.[teamName];
        const statusEl = document.getElementById("status");
        const form = document.getElementById("antwortForm");

        if (vorhanden) {
          statusEl.textContent = "Du hast diese Runde bereits abgegeben.";
          statusEl.className = "status abgegeben";
          form.style.display = "none";
        } else {
          form.style.display = "block";
        }
      }catch(e){ console.error(e); }
    }

    async function submitAnswers(e){
      e.preventDefault();
      const form = document.getElementById("antwortForm");
      const formData = new FormData(form);
      const answers = [];
      for (let i = 1; i <= 12; i++) answers.push(formData.get(`a${i}`) || "");

      // State frisch holen
      const res = await fetch("/current-round");
      const data = await res.json();
      const aktuelleRunde = parseInt(data.round, 10);

      const payload = { teamName, round: aktuelleRunde, answers };

      try{
        const response = await fetch("/submit-answers", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(payload),
        });

        const statusEl = document.getElementById("status");

        if (response.status === 200) {
          statusEl.textContent = "Antworten erfolgreich abgegeben!";
          statusEl.className = "status abgegeben";
          form.style.display = "none";
        } else if (response.status === 409) {
          statusEl.textContent = "Du hast bereits abgegeben.";
          statusEl.className = "status abgegeben";
          form.style.display = "none";
        } else if (response.status === 423) {
          statusEl.textContent = "Runde beendet – nächste Runde in ein paar Minuten.";
          statusEl.className = "status gesperrt";
          form.style.display = "none";
          showWait(true, aktuelleRunde, true);
        } else {
          statusEl.textContent = "Fehler beim Absenden!";
          statusEl.className = "status";
        }
      }catch(err){
        document.getElementById("status").textContent = "Serverfehler";
      }
    }
  </script>
</body>
</html>