<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8" />
  <title>Runden-Ansichten – Teamantworten</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="stylesheet" href="style.css" />
  <style>
    :root{
      --fg:#0f172a; --muted:#64748b; --accent:#3b82f6;
      --accent-2:#22c55e; --accent-3:#ef4444;
      --bg-from:#ffffff; --bg-to:#f6f8fb; --card:#ffffff;
      --ring: rgba(59,130,246,.18); --border:#e5e7eb; --shadow: 0 6px 20px rgba(2,6,23,.08);
    }
    html,body{height:100%}
    body{
      margin:0; padding:0; font-family:system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      color:var(--fg);
      background: linear-gradient(180deg, var(--bg-from), var(--bg-to));
      min-height:100dvh;
    }
    .wrap{ width:min(1100px, 96vw); margin:28px auto 40px; }
    h1{ margin:0 0 8px; }
    .sub{ color:var(--muted); margin:0 0 20px; }

    .toolbar{
      display:flex; flex-wrap:wrap; gap:10px; align-items:center;
      background:var(--card); border:1px solid var(--border); border-radius:14px; padding:12px; box-shadow:var(--shadow);
    }
    .toolbar > *{ margin-right:8px; }
    select, input[type="text"]{
      padding:10px 12px; border:1px solid var(--border); border-radius:10px; font-size:14px; outline:none;
    }
    select:focus, input[type="text"]:focus{ box-shadow:0 0 0 4px var(--ring); border-color:#93c5fd; }
    .btn{ padding:10px 14px; border:1px solid var(--border); border-radius:10px; background:#fff; cursor:pointer; }
    .btn:hover{ filter:saturate(1.05); }
    .switch{ display:inline-flex; align-items:center; gap:6px; }
    .card{
      background:var(--card); border:1px solid var(--border); border-radius:16px; padding:16px; box-shadow:var(--shadow);
      margin-top:14px; overflow:auto;
    }
    table{ width:100%; border-collapse:collapse; font-size:14px; }
    thead th{
      position:sticky; top:0; background:#f8fafc; border-bottom:1px solid var(--border);
      text-align:left; padding:10px; font-weight:700;
    }
    tbody td{ border-bottom:1px solid #eef2f7; padding:8px 10px; vertical-align:top; }
    .mono{ font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, "Liberation Mono", monospace; }
    .badge{
      display:inline-block; padding:.2rem .5rem; border:1px solid var(--border); border-radius:999px; font-size:.8rem; color:#0f172a; background:#fff;
    }
    .muted{ color:var(--muted); }
    .right{ text-align:right; }
  </style>
</head>
<body>
  <div class="wrap">
    <h1>Team-Antworten pro Runde</h1>
    <p class="sub">Während z. B. Runde 5 läuft, kannst du hier die Antworten aus anderen Runden (1–10) ansehen.</p>

    <div class="toolbar">
      <label>Runde:
        <select id="roundSelect"></select>
      </label>

      <label>Team filtern:
        <input type="text" id="teamFilter" placeholder="Teamname…">
      </label>

      <span class="switch">
        <input type="checkbox" id="onlySubmitted" />
        <label for="onlySubmitted">Nur Abgaben zeigen</label>
      </span>

      <button class="btn" id="reloadBtn">Neu laden</button>

      <span class="switch">
        <input type="checkbox" id="autoRefresh" />
        <label for="autoRefresh">Auto-Refresh (alle 5 s)</label>
      </span>

      <span id="status" class="muted"></span>
    </div>

    <div class="card">
      <table id="answersTable">
        <thead>
          <tr>
            <th style="min-width:180px">Team</th>
            <th class="mono">1</th><th class="mono">2</th><th class="mono">3</th><th class="mono">4</th><th class="mono">5</th><th class="mono">6</th>
            <th class="mono">7</th><th class="mono">8</th><th class="mono">9</th><th class="mono">10</th><th class="mono">11</th><th class="mono">12</th>
            <th style="min-width:120px">Abgegeben</th>
          </tr>
        </thead>
        <tbody id="tbody"></tbody>
      </table>
    </div>
  </div>

  <script>
    const MAX_ROUNDS = 10;

    const roundSelect   = document.getElementById('roundSelect');
    const teamFilter    = document.getElementById('teamFilter');
    const onlySubmitted = document.getElementById('onlySubmitted');
    const reloadBtn     = document.getElementById('reloadBtn');
    const autoRefreshCb = document.getElementById('autoRefresh');
    const statusEl      = document.getElementById('status');
    const tbody         = document.getElementById('tbody');

    let timer = null;
    let allTeams = [];

    // Runde-Options dynamisch 1..10
    function buildRoundOptions(selectedRound){
      roundSelect.innerHTML = '';
      for(let r=1;r<=MAX_ROUNDS;r++){
        const opt = document.createElement('option');
        opt.value = r; opt.textContent = `Runde ${r}`;
        if (r === selectedRound) opt.selected = true;
        roundSelect.appendChild(opt);
      }
    }

    async function loadTeams(){
      try{ allTeams = await fetch('/teams').then(r=>r.json()); }
      catch{ allTeams = []; }
    }

    async function loadAndRender(){
      clearTimeout(timer);
      const r = +roundSelect.value;
      const filter = (teamFilter.value || '').toLowerCase().trim();
      const onlyAbgabe = !!onlySubmitted.checked;
      status('Lade …');

      try{
        const [allAnswers] = await Promise.all([
          fetch('/data/teamAnswers.json').then(r=>r.json())
        ]);
        const key = `round_${r}`;
        const byTeam = allAnswers[key] || {};

        // Wenn wir eine vollständige Teamliste haben, nutzen wir die – sonst nur die mit Abgabe
        const teams = (Array.isArray(allTeams) && allTeams.length)
          ? allTeams.slice()
          : Object.keys(byTeam);

        const rows = teams
          .filter(t => t.toLowerCase().includes(filter))
          .filter(t => !onlyAbgabe || byTeam[t])
          .sort((a,b) => a.localeCompare(b, 'de'));

        tbody.innerHTML = '';
        if (rows.length === 0){
          const tr = document.createElement('tr');
          const td = document.createElement('td');
          td.colSpan = 14;
          td.className = 'muted';
          td.textContent = 'Keine Einträge gefunden.';
          tr.appendChild(td);
          tbody.appendChild(tr);
        } else {
          for (const team of rows){
            const entry = byTeam[team] || null;
            const answers = entry?.answers || [];
            const timestamp = entry?.timestamp || null;

            const tr = document.createElement('tr');

            const tdTeam = document.createElement('td');
            tdTeam.innerHTML = `<span class="badge">${escapeHtml(team)}</span>`;
            tr.appendChild(tdTeam);

            for (let i=0;i<12;i++){
              const td = document.createElement('td');
              const val = (answers[i] ?? '').toString();
              td.textContent = val || (entry ? '' : '–');
              tr.appendChild(td);
            }

            const tdTime = document.createElement('td');
            tdTime.className = 'muted right';
            tdTime.textContent = timestamp ? new Date(timestamp).toLocaleTimeString() : (entry ? '–' : 'keine Abgabe');
            tr.appendChild(tdTime);

            tbody.appendChild(tr);
          }
        }
        status(`Runde ${r}: ${rows.length} Teams`);
      }catch(e){
        console.error(e);
        status('Fehler beim Laden');
      } finally {
        if (autoRefreshCb.checked){
          timer = setTimeout(loadAndRender, 5000);
        }
      }
    }

    function status(txt){ statusEl.textContent = txt; }
    function escapeHtml(s){ return s.replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m])); }

    reloadBtn.addEventListener('click', loadAndRender);
    roundSelect.addEventListener('change', loadAndRender);
    teamFilter.addEventListener('input', () => { if (!autoRefreshCb.checked) loadAndRender(); });
    onlySubmitted.addEventListener('change', loadAndRender);
    autoRefreshCb.addEventListener('change', loadAndRender);

    // Init: aktuelle Runde vorwählen & Teams cachen
    (async function init(){
      try{
        const r = await fetch('/current-round').then(r=>r.json());
        const cr = parseInt(r.round||1,10);
        buildRoundOptions(Math.min(MAX_ROUNDS, Math.max(1, cr)));
      }catch{
        buildRoundOptions(1);
      }
      await loadTeams();
      loadAndRender();
    })();
  </script>
</body>
</html>